<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Summon - The Mythical Cursed-Nightmare</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="alternate icon" href="favicon.svg" />

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.svg" />

    <!-- PWA対応 -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <!-- OGP Meta Tags -->
    <meta property="og:title" content="Summon Your Nightmare - The Mythical Cursed-Nightmare" />
    <meta property="og:description" content="Summon your cursed creature from the digital abyss" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="apple-touch-icon.svg" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: monospace;
        background: linear-gradient(180deg, #0a0a0a 0%, #1a0a2a 100%);
        color: #fff;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow-x: hidden;
        position: relative;
      }

      /* 背景エフェクト */
      .bg-particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      .particle {
        position: absolute;
        background: #9b4dff;
        border-radius: 50%;
        opacity: 0;
        animation: float 15s infinite;
      }

      @keyframes float {
        0%,
        100% {
          opacity: 0;
          transform: translateY(100vh) scale(0);
        }
        10% {
          opacity: 0.4;
        }
        90% {
          opacity: 0.4;
        }
        100% {
          transform: translateY(-100vh) scale(1);
        }
      }

      /* メインコンテナ */
      .container {
        text-align: center;
        z-index: 10;
        padding: 2rem;
        max-width: 1200px;
        width: 100%;
      }

      /* ヘッダー */
      .header {
        margin-bottom: 3rem;
      }

      h1 {
        font-size: clamp(2rem, 5vw, 3.5rem);
        background: linear-gradient(45deg, #9b4dff, #ff4d4d, #9b4dff);
        background-size: 200% 200%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: gradient 3s ease infinite;
        margin-bottom: 1rem;
      }

      @keyframes gradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      /* Contract Name Title - same style as h1 */
      .contract-name-title {
        font-size: clamp(1rem, 3vw, 1.5rem);
        background: linear-gradient(45deg, #9b4dff, #ff4d4d, #9b4dff);
        background-size: 200% 200%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: gradient 3s ease infinite;
        font-weight: bold;
        margin: 0;
      }

      .subtitle {
        color: #b792ff;
        font-size: 1.2rem;
        margin-bottom: 2rem;
      }

      /* Wallet Connection */
      .wallet-section {
        background: rgba(155, 77, 255, 0.1);
        border: 2px solid #9b4dff;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
      }

      .wallet-status {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ff4d4d;
        animation: pulse 2s infinite;
      }

      .status-dot.connected {
        background: #4dff4d;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .wallet-address {
        font-size: 1.1rem;
        color: #e9d5ff;
        margin-bottom: 1rem;
      }

      .connect-btn {
        background: linear-gradient(45deg, #9b4dff, #ff4d4d);
        color: white;
        border: none;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .connect-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(155, 77, 255, 0.5);
      }

      .connect-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Mint Section */
      .mint-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .mint-preview {
        background: rgba(0, 0, 0, 0.5);
        border: 2px solid #9b4dff;
        border-radius: 20px;
        padding: 2rem;
        position: relative;
        overflow: hidden;
      }

      .preview-image {
        width: 100%;
        max-width: 400px;
        height: auto;
        border-radius: 10px;
        filter: brightness(0.9) contrast(1.2) drop-shadow(0 0 15px #9b4dff);
        transition: all 0.3s;
        animation: imageGlow 3s ease-in-out infinite;
      }

      @keyframes imageGlow {
        0%,
        100% {
          filter: brightness(0.9) contrast(1.2) drop-shadow(0 0 15px #9b4dff);
        }
        50% {
          filter: brightness(1) contrast(1.3) drop-shadow(0 0 30px #ff4dff);
        }
      }

      .preview-image:hover {
        filter: brightness(1.1) contrast(1.3) drop-shadow(0 0 40px #ffffff);
        transform: scale(1.05);
        animation: none;
      }

      .mint-controls {
        background: rgba(155, 77, 255, 0.05);
        border: 2px solid #9b4dff;
        border-radius: 20px;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .supply-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .info-box {
        background: rgba(0, 0, 0, 0.5);
        padding: 1rem;
        border-radius: 10px;
        border: 1px solid #9b4dff;
      }

      .info-label {
        color: #b792ff;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
      }

      .info-value {
        color: #fff;
        font-size: 1.5rem;
        font-weight: bold;
      }

      .price-display {
        background: linear-gradient(45deg, #9b4dff, #ff4d4d);
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
      }

      .price-label {
        font-size: 1rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .price-value {
        font-size: 2.5rem;
        font-weight: bold;
        text-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      }

      .price-reason {
        margin-top: 1rem;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.8);
        line-height: 1.6;
        font-style: italic;
        text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        position: relative;
        min-height: 100px;
      }

      .price-reason-text {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }

      .price-reason-text.active {
        opacity: 1;
      }

      .quantity-selector {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .quantity-btn {
        background: rgba(155, 77, 255, 0.2);
        border: 2px solid #9b4dff;
        color: #fff;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s;
      }

      .quantity-btn:hover {
        background: rgba(155, 77, 255, 0.4);
        transform: scale(1.1);
      }

      .quantity-display {
        font-size: 1.5rem;
        min-width: 50px;
      }

      .mint-btn {
        background: linear-gradient(45deg, #ff4d4d, #9b4dff);
        color: white;
        border: none;
        padding: 1.5rem 3rem;
        font-size: 1.3rem;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        width: 100%;
        position: relative;
        overflow: hidden;
      }

      .mint-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
      }

      .mint-btn:hover::before {
        left: 100%;
      }

      .mint-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(255, 77, 77, 0.5);
      }

      .mint-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Transaction Status */
      .transaction-status {
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #4dff4d;
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 2rem;
        display: none;
      }

      .transaction-status.error {
        border-color: #ff4d4d;
      }

      .transaction-status.pending {
        border-color: #ffd700;
      }

      .status-message {
        font-size: 1.1rem;
        margin-bottom: 1rem;
      }

      .tx-hash {
        font-family: monospace;
        font-size: 0.9rem;
        color: #b792ff;
        word-break: break-all;
      }

      .tx-link {
        color: #9b4dff;
        text-decoration: underline;
      }

      /* Navigation */
      .nav-links {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 3rem;
      }

      .nav-link {
        color: #b792ff;
        text-decoration: none;
        padding: 0.8rem 1.5rem;
        border: 1px solid #9b4dff;
        border-radius: 25px;
        transition: all 0.3s;
      }

      .nav-link:hover {
        background: rgba(155, 77, 255, 0.2);
        transform: translateY(-2px);
      }

      /* Loading Spinner */
      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid #9b4dff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .mint-section {
          grid-template-columns: 1fr;
        }

        .price-value {
          font-size: 2rem;
        }

        .mint-btn {
          font-size: 1.1rem;
          padding: 1.2rem 2rem;
        }

        /* Simplify navigation buttons on mobile */
        .nav-links {
          gap: 1rem;
        }

        .nav-link {
          padding: 0.6rem 1rem;
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- 背景パーティクル -->
    <div class="bg-particles" id="particles"></div>

    <!-- メインコンテンツ -->
    <div class="container">
      <div class="header">
        <h1>Summon Your Nightmare</h1>
        <p class="subtitle">Mint your cursed creature from the digital abyss</p>
      </div>

      <!-- Wallet Connection Section (will be reordered on mobile) -->
      <div class="wallet-section" id="walletSection">
        <div class="wallet-status">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Wallet Not Connected</span>
        </div>
        <div class="wallet-address" id="walletAddress"></div>
        <button class="connect-btn" id="connectBtn" onclick="connectWallet()">Connect MetaMask</button>
      </div>

      <!-- Mint Section -->
      <div class="mint-section" id="mintSection" style="display: none">
        <div class="mint-preview">
          <img src="assets/monsters/question.svg" alt="Mystery Creature" class="preview-image" id="previewImage" />
          <p style="color: #b792ff; margin-top: 1rem; font-style: italic">Which nightmare will answer your call?</p>
        </div>

        <div class="mint-controls">
          <div class="contract-name-display" style="text-align: center; margin-bottom: 1.5rem">
            <div class="contract-name-title" id="contractName">Loading...</div>
          </div>

          <div class="supply-info">
            <div class="info-box">
              <div class="info-label">Minted</div>
              <div class="info-value" id="totalSupply">0</div>
            </div>
            <div class="info-box">
              <div class="info-label">Max Supply</div>
              <div class="info-value" id="maxSupply">10,000</div>
            </div>
          </div>

          <div class="price-display">
            <div class="price-label">Price</div>
            <div class="price-value" id="priceDisplay">33 POL</div>
            <div class="price-reason" id="priceReason">
              33 POL - The Master Number of Transformation<br />
              <span style="font-size: 0.8em; opacity: 0.9">
                At 33, souls reach a crossroads between light and shadow.<br />
                In Japanese tradition, 33 marks spiritual awakening.<br />
                But what awakens in the digital realm... may be nightmares.
              </span>
            </div>
          </div>

          <button class="mint-btn" id="mintBtn" onclick="mintNFT()" disabled>SUMMON NIGHTMARE</button>
        </div>
      </div>

      <!-- Transaction Status -->

      <!-- Navigation -->
      <div class="nav-links">
        <a href="index.html" class="nav-link"> ← Back to Home </a>
        <a
          href="https://opensea.io/ja/collection/something-dark-is-awakening"
          class="nav-link"
          id="openseaLink"
          target="_blank"
        >
          View on OpenSea
        </a>
        <a
          href="https://polygonscan.com/address/"
          id="polygonscanLink"
          class="nav-link"
          id="basescanLink"
          target="_blank"
        >
          View on PolygonScan
        </a>
      </div>
    </div>

    <!-- Console override for debugging -->
    <script src="js/utils/console-override.js"></script>

    <!-- Ethers.js v5 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <!-- Common utilities and managers -->
    <script src="js/utils/format.js"></script>
    <script src="js/wallet/manager.js"></script>
    <script src="js/contracts/manager.js"></script>

    <!-- Common UI Components -->
    <script src="js/ui/components.js"></script>

    <!-- Import MetaMask modal functionality -->
    <script src="js/ui/metamask-modal-translations.js"></script>
    <script src="js/ui/metamask-modal.js"></script>

    <script>
      let nftPrice = 33;
      let isConnected = false;
      let walletManager = null;
      let contractManager = null;

      // Initialize WalletManager
      async function initializeWalletManager() {
        walletManager = new WalletManager({
          defaultNetwork: 'polygon',
          onConnect: async (account, chainId) => {
            isConnected = true;

            // Initialize ContractManager with signer
            const provider = walletManager.getProvider();
            const signer = walletManager.getSigner();

            contractManager = new ContractManager();
            await contractManager.initialize(provider, 'deployment', signer);

            // Update UI using existing function
            window.updateWalletUI(account);
          },
          onDisconnect: () => {
            isConnected = false;
            window.updateWalletUI(null);
          },
          onAccountChange: async (account) => {
            // Update ContractManager signer
            if (contractManager) {
              const signer = walletManager.getSigner();
              contractManager.updateSigner(signer);
            }
            window.updateWalletUI(account);
          },
          onNetworkChange: (chainId) => {
            window.location.reload();
          },
        });

        return await walletManager.init();
      }

      // Load settings and update campaign contract address
      async function loadSettings() {
        try {
          const response = await fetch('config/settings.json');
          if (response.ok) {
            const settings = await response.json();
            const campaignAddress = settings.contracts.Campaign;
            if (campaignAddress) {
              const polygonscanLink = document.getElementById('polygonscanLink');
              if (polygonscanLink) {
                polygonscanLink.href = `https://polygonscan.com/address/${campaignAddress}`;
              }
            }
          }
        } catch (error) {
          console.error('Failed to load settings.json:', error);
        }
      }

      // パーティクル生成
      function createParticles() {
        const container = document.getElementById('particles');
        const particleCount = 30;

        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.left = Math.random() * 100 + '%';
          particle.style.width = Math.random() * 4 + 2 + 'px';
          particle.style.height = particle.style.width;
          particle.style.animationDelay = Math.random() * 15 + 's';
          particle.style.animationDuration = Math.random() * 10 + 15 + 's';
          container.appendChild(particle);
        }
      }

      // Update wallet UI
      window.updateWalletUI = async function (account) {
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const walletAddress = document.getElementById('walletAddress');
        const connectBtn = document.getElementById('connectBtn');
        const mintSection = document.getElementById('mintSection');
        const mintBtn = document.getElementById('mintBtn');

        if (account) {
          isConnected = true;
          statusDot.classList.add('connected');
          statusText.textContent = 'Wallet Connected';
          walletAddress.textContent = formatAddress(account);
          connectBtn.textContent = 'Disconnect';
          mintSection.style.display = 'grid';
          mintBtn.disabled = false;

          // Update supply info
          updateSupplyInfo();

          // Update external links with contract address
          updateExternalLinks();
        } else {
          isConnected = false;
          statusDot.classList.remove('connected');
          statusText.textContent = 'Wallet Not Connected';
          walletAddress.textContent = '';
          connectBtn.textContent = 'Connect MetaMask';
          mintSection.style.display = 'none';
          mintBtn.disabled = true;
        }
      };

      // Update OpenSea and BaseScan links with contract address
      async function updateExternalLinks() {
        try {
          // Get current chain ID
          const chainId = await window.ethereum.request({
            method: 'eth_chainId',
          });
          const chainIdDecimal = parseInt(chainId, 16);

          // Get contract address for current network
          const contractAddress = contractManager ? contractManager.getContractAddress('bankedNFT') : null;

          const openseaLink = document.getElementById('openseaLink');
          const basescanLink = document.getElementById('polygonscanLink');

          openseaLink.textContent = 'View on OpenSea';
          openseaLink.href = `https://opensea.io/collection/the-mythical-cursed-nightmare`;
          basescanLink.textContent = 'View on PolygonScan';
          basescanLink.href = `https://polygonscan.com/address/${contractAddress}`;
        } catch (error) {
          console.error('Failed to update external links:', error);
        }
      }

      // Text switching animation
      function startTextSwitching() {
        const originalText = document.getElementById('originalText');
        const discountText = document.getElementById('discountText');

        if (!originalText || !discountText) return;

        // Start with discount text visible
        originalText.classList.remove('active');
        discountText.classList.add('active');
        let showingOriginal = false;

        setInterval(() => {
          if (showingOriginal) {
            originalText.classList.remove('active');
            discountText.classList.add('active');
          } else {
            discountText.classList.remove('active');
            originalText.classList.add('active');
          }
          showingOriginal = !showingOriginal;
        }, 5000);
      }

      // Animate price countdown
      function animatePriceCountdown(startPrice, endPrice) {
        const priceDisplay = document.getElementById('priceDisplay');
        const duration = 6000; // 6 seconds
        const fps = 60;
        const totalFrames = (duration / 1000) * fps;
        const priceDecrement = (startPrice - endPrice) / totalFrames;
        let currentPrice = startPrice;
        let frame = 0;

        const animate = () => {
          frame++;
          currentPrice = startPrice - priceDecrement * frame;

          // Easing function for smoother animation
          const progress = frame / totalFrames;
          const easedProgress = 1 - Math.pow(1 - progress, 3); // Cubic ease-out
          currentPrice = startPrice - (startPrice - endPrice) * easedProgress;

          if (frame >= totalFrames) {
            currentPrice = endPrice;
          }

          priceDisplay.textContent = `${currentPrice.toFixed(2)} POL`;

          if (frame < totalFrames) {
            requestAnimationFrame(animate);
          } else {
            // Final display with proper decimal places
            if (endPrice % 1 === 0) {
              priceDisplay.textContent = `${endPrice} POL`;
            } else {
              priceDisplay.textContent = `${endPrice.toFixed(1)} POL`;
            }

            // Update price reason text after countdown
            const priceReason = document.getElementById('priceReason');
            if (priceReason) {
              // Calculate discount percentage
              const discountPercentage = Math.round(((33 - endPrice) / 33) * 100);

              // Create two text elements for switching
              const originalText = `
                <div class="price-reason-text" id="originalText">
                  33 POL - The Master Number of Transformation<br />
                  <span style="font-size: 0.8em; opacity: 0.9">
                    At 33, souls reach a crossroads between light and shadow.<br />
                    In Japanese tradition, 33 marks spiritual awakening.<br />
                    But what awakens in the digital realm... may be nightmares.
                  </span>
                </div>
              `;

              const discountText = `
                <div class="price-reason-text" id="discountText">
                  ${endPrice.toFixed(1)} POL - Limited Time Early Bird Special!<br />
                  <span style="font-size: 0.8em; opacity: 0.9">
                    🔥 Exclusive launch price - Save ${discountPercentage}%!<br />
                    Original price: 33 POL → Now only ${endPrice.toFixed(1)} POL<br />
                    Don't miss this rare opportunity to summon your nightmare.
                  </span>
                </div>
              `;

              priceReason.innerHTML = originalText + discountText;

              // Start text switching animation
              startTextSwitching();
            }
          }
        };

        animate();
      }

      // Connect/Disconnect wallet
      async function connectWallet() {
        const connectBtn = document.getElementById('connectBtn');

        if (isConnected) {
          // Disconnect
          if (walletManager) {
            walletManager.disconnect();
          }
        } else {
          // Connect
          connectBtn.disabled = true;
          connectBtn.textContent = 'Connecting...';

          try {
            if (walletManager) {
              await walletManager.connect('polygon');
            }
          } catch (error) {
            console.error('Connection failed:', error);

            // Check if MetaMask is not installed
            if (error.message.includes('MetaMask is not installed')) {
              showAlert('MetaMask is not installed! Please install MetaMask to mint NFTs.', 'error', 0);
            } else {
              showAlert(error.message, 'error');
            }
          } finally {
            connectBtn.disabled = false;
            connectBtn.textContent = 'Connect MetaMask';
          }
        }
      }

      // Update supply information
      async function updateSupplyInfo() {
        try {
          // Get current chain ID
          const chainId = await window.ethereum.request({
            method: 'eth_chainId',
          });
          const chainIdDecimal = parseInt(chainId, 16);

          // Check if contract is deployed first
          let contractAddress;
          if (contractManager) {
            contractAddress = contractManager.getContractAddress('bankedNFT');
          } else {
            contractAddress = window.web3Integration.getContractAddress();
          }

          if (!contractAddress || contractAddress === '0x0000000000000000000000000000000000000000') {
            // Set default values when contract is not deployed
            document.getElementById('contractName').textContent = 'Something Dark';
            document.getElementById('totalSupply').textContent = '0';
            document.getElementById('maxSupply').textContent = '10,000';
            document.getElementById('priceDisplay').textContent = '33 POL';
            nftPrice = 33;
            return;
          }

          // Get contract name first
          try {
            const bankedNFTContract = contractManager.getContract('bankedNFT');
            const contractName = bankedNFTContract ? await bankedNFTContract.name() : 'Unknown';
            document.getElementById('contractName').textContent = contractName;
          } catch (error) {
            console.error('Failed to get contract name:', error);
            document.getElementById('contractName').textContent = 'Unknown Collection';
          }

          const bankedNFTContract = contractManager.getContract('bankedNFT');
          const totalSupply = bankedNFTContract ? await bankedNFTContract.totalSupply() : 0;
          const maxSupply = bankedNFTContract ? await bankedNFTContract.maxSupply() : 0;

          document.getElementById('totalSupply').textContent = totalSupply;
          document.getElementById('maxSupply').textContent = Number(maxSupply).toLocaleString();

          // Get NFT price
          if (contractManager) {
            const bankedNFTContract = contractManager.getContract('bankedNFT');
            if (bankedNFTContract) {
              const priceWei = await bankedNFTContract.mintFee();
              // Handle both ethers v5 and v6
              const formatEther = ethers.formatEther || (ethers.utils && ethers.utils.formatEther);
              const actualPrice = parseFloat(formatEther(priceWei));

              // Wait 1 second before starting countdown
              setTimeout(() => {
                // Animate price countdown from 33 to actual price
                animatePriceCountdown(33, actualPrice);
              }, 3000);
              nftPrice = actualPrice;
            }
          } else {
            document.getElementById('priceDisplay').textContent = `${nftPrice} POL`;
          }
        } catch (error) {
          console.error('Failed to update supply info:', error);

          // Get current chain ID
          try {
            const chainId = await window.ethereum.request({
              method: 'eth_chainId',
            });
            const chainIdDecimal = parseInt(chainId, 16);

            // Set default values on error
            document.getElementById('contractName').textContent = 'Unknown Collection';
            document.getElementById('totalSupply').textContent = '0';
            document.getElementById('maxSupply').textContent = '10,000';
            document.getElementById('priceDisplay').textContent = '33 POL';
            nftPrice = 33;
          } catch {
            // Set default values on error
            document.getElementById('contractName').textContent = 'Unknown Collection';
            document.getElementById('totalSupply').textContent = '0';
            document.getElementById('maxSupply').textContent = '10,000';
            document.getElementById('priceDisplay').textContent = '33 POL';
            nftPrice = 33;
          }
        }
      }

      // Mint NFT
      async function mintNFT() {
        // Check if contract is deployed
        let contractAddress;
        if (contractManager) {
          contractAddress = contractManager.getContractAddress('bankedNFT');
        }

        // Get current chain ID
        const chainId = await window.ethereum.request({
          method: 'eth_chainId',
        });
        const chainIdDecimal = parseInt(chainId, 16);

        if (!contractAddress || contractAddress === '0x0000000000000000000000000000000000000000') {
          showComingSoonModal();
          return;
        }

        const mintBtn = document.getElementById('mintBtn');
        mintBtn.disabled = true;
        mintBtn.innerHTML = '<div class="spinner"></div>';

        showTransactionModal({
          title: 'Transaction Pending',
          message: 'Summoning your nightmare... Please confirm the transaction in MetaMask.',
          status: 'pending',
        });

        try {
          // Mint NFT using ContractManager
          const bankedNFTContract = contractManager.getContract('bankedNFT');
          if (!bankedNFTContract) {
            throw new Error('Contract not initialized');
          }

          // Debug info
          console.log('Minting on network:', contractManager.networkId);
          console.log('Contract address:', contractManager.getContractAddress('bankedNFT'));

          const mintFee = await bankedNFTContract.mintFee();
          console.log('Mint fee:', mintFee.toString());

          const tx = await bankedNFTContract.mint({ value: mintFee });
          const receipt = await tx.wait();

          const result = {
            success: receipt.status === 1,
            transactionHash: receipt.transactionHash,
          };

          if (result.success) {
            showTransactionModal({
              title: 'Summoning Successful',
              message: `Success! Your nightmare has been summoned! Token ID: ${result.tokenId || 'Processing...'}`,
              status: 'success',
              txHash: result.transactionHash,
            });

            // Update supply after successful mint
            setTimeout(updateSupplyInfo, 3000);
          }
        } catch (error) {
          console.error('Minting failed:', error);
          console.error('Error details:', {
            message: error.message,
            code: error.code,
            data: error.data,
            reason: error.reason,
          });

          let errorMessage = 'The summoning ritual failed. ';

          if (error.message && error.message.includes('insufficient funds')) {
            errorMessage += 'Insufficient POL balance.';
          } else if (error.code === 4001 || (error.message && error.message.includes('user rejected'))) {
            errorMessage += 'Transaction was cancelled.';
          } else if (error.message && error.message.includes('Contract not initialized')) {
            {
              showComingSoonModal();
            }
            mintBtn.disabled = false;
            mintBtn.textContent = 'SUMMON NIGHTMARE';
            return;
          } else {
            errorMessage += error.message;
          }

          showAlert(errorMessage, 'error');
        } finally {
          mintBtn.disabled = false;
          mintBtn.textContent = 'SUMMON NIGHTMARE';
        }
      }

      // Show coming soon modal
      function showComingSoonModal() {
        // Create modal overlay
        const modal = document.createElement('div');
        modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.95);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                animation: fadeIn 0.3s;
            `;

        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
                background: linear-gradient(180deg, #1a0a2a 0%, #0a0a0a 100%);
                border: 2px solid #9b4dff;
                border-radius: 20px;
                padding: 40px;
                text-align: center;
                max-width: 500px;
                box-shadow: 0 0 50px rgba(155, 77, 255, 0.5);
            `;

        modalContent.innerHTML = `
                <h2 style="color: #ff4d4d; font-size: 2em; margin-bottom: 20px; text-shadow: 0 0 20px rgba(255, 77, 77, 0.8);">
                    🔒 The Seal Remains Unbroken
                </h2>
                <p style="color: #e9d5ff; font-size: 1.2em; margin-bottom: 15px; line-height: 1.6;">
                    The ancient contract has not yet been inscribed into the blockchain...
                </p>
                <p style="color: #b792ff; font-size: 1.1em; margin-bottom: 30px; font-style: italic;">
                    The nightmares are still gathering their strength. Return when the moon is full.
                </p>
                <div style="background: rgba(155, 77, 255, 0.2); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: #9b4dff; font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">
                        COMING SOON
                    </p>
                    <p style="color: #b792ff; font-size: 0.9em;">
                        Pre-launch: September 1, 2025<br>
                        Main Launch: October 1, 2025
                    </p>
                </div>
                <button id="closeModalBtn" style="
                    background: linear-gradient(45deg, #9b4dff, #ff4d4d);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    font-size: 1.1em;
                    border-radius: 50px;
                    cursor: pointer;
                    font-weight: bold;
                    transition: all 0.3s;
                ">Understood</button>
            `;

        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        // Close button handler
        document.getElementById('closeModalBtn').onclick = () => {
          modal.style.animation = 'fadeOut 0.3s';
          setTimeout(() => modal.remove(), 300);
        };

        // Click outside to close
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.style.animation = 'fadeOut 0.3s';
            setTimeout(() => modal.remove(), 300);
          }
        });
      }

      // Preview image rotation
      function rotatePreviewImages() {
        const images = [
          'assets/monsters/demon.svg',
          'assets/monsters/vampire.svg',
          'assets/monsters/werewolf.svg',
          'assets/monsters/zombie.svg',
          'assets/monsters/frankenstein.svg',
          'assets/monsters/question.svg',
        ];

        let currentIndex = 0;
        const previewImg = document.getElementById('previewImage');

        setInterval(() => {
          currentIndex = (currentIndex + 1) % images.length;
          previewImg.style.opacity = '0';

          setTimeout(() => {
            previewImg.src = images[currentIndex];
            previewImg.style.opacity = '1';
          }, 300);
        }, 3000);
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', async () => {
        // Check browser and show MetaMask warning
        checkBrowserAndShowMetaMaskWarning();
        // Initialize UI Components
        initializeUIStyles();

        // Initialize WalletManager
        await initializeWalletManager();

        // Check if wallet already connected
        if (walletManager && walletManager.isWalletConnected()) {
          const provider = walletManager.getProvider();
          const signer = walletManager.getSigner();

          // Initialize ContractManager
          contractManager = new ContractManager();
          await contractManager.initialize(provider, signer);
        }

        loadSettings();
        createParticles();
        rotatePreviewImages();

        // Check if wallet is already connected
        if (window.ethereum && window.ethereum.selectedAddress) {
          connectWallet();
        }
      });
    </script>
  </body>
</html>
