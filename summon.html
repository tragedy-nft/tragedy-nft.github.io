<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Summon - The Mythical Cursed-Nightmare</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="alternate icon" href="favicon.svg" />

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.svg" />

    <!-- PWA対応 -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <!-- OGP Meta Tags -->
    <meta
      property="og:title"
      content="Summon Your Nightmare - The Mythical Cursed-Nightmare"
    />
    <meta
      property="og:description"
      content="Summon your cursed creature from the digital abyss"
    />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="apple-touch-icon.svg" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: monospace;
        background: linear-gradient(180deg, #0a0a0a 0%, #1a0a2a 100%);
        color: #fff;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow-x: hidden;
        position: relative;
      }

      /* 背景エフェクト */
      .bg-particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      .particle {
        position: absolute;
        background: #9b4dff;
        border-radius: 50%;
        opacity: 0;
        animation: float 15s infinite;
      }

      @keyframes float {
        0%,
        100% {
          opacity: 0;
          transform: translateY(100vh) scale(0);
        }
        10% {
          opacity: 0.4;
        }
        90% {
          opacity: 0.4;
        }
        100% {
          transform: translateY(-100vh) scale(1);
        }
      }

      /* メインコンテナ */
      .container {
        text-align: center;
        z-index: 10;
        padding: 2rem;
        max-width: 1200px;
        width: 100%;
      }

      /* ヘッダー */
      .header {
        margin-bottom: 3rem;
      }

      h1 {
        font-size: clamp(2rem, 5vw, 3.5rem);
        background: linear-gradient(45deg, #9b4dff, #ff4d4d, #9b4dff);
        background-size: 200% 200%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: gradient 3s ease infinite;
        margin-bottom: 1rem;
      }

      @keyframes gradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      /* Contract Name Title - same style as h1 */
      .contract-name-title {
        font-size: clamp(1rem, 3vw, 1.5rem);
        background: linear-gradient(45deg, #9b4dff, #ff4d4d, #9b4dff);
        background-size: 200% 200%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: gradient 3s ease infinite;
        font-weight: bold;
        margin: 0;
      }

      .subtitle {
        color: #b792ff;
        font-size: 1.2rem;
        margin-bottom: 2rem;
      }

      /* Wallet Connection */
      .wallet-section {
        background: rgba(155, 77, 255, 0.1);
        border: 2px solid #9b4dff;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
      }

      .wallet-status {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ff4d4d;
        animation: pulse 2s infinite;
      }

      .status-dot.connected {
        background: #4dff4d;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .wallet-address {
        font-size: 1.1rem;
        color: #e9d5ff;
        margin-bottom: 1rem;
      }

      .connect-btn {
        background: linear-gradient(45deg, #9b4dff, #ff4d4d);
        color: white;
        border: none;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .connect-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(155, 77, 255, 0.5);
      }

      .connect-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Mint Section */
      .mint-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .mint-preview {
        background: rgba(0, 0, 0, 0.5);
        border: 2px solid #9b4dff;
        border-radius: 20px;
        padding: 2rem;
        position: relative;
        overflow: hidden;
      }

      .preview-image {
        width: 100%;
        max-width: 400px;
        height: auto;
        border-radius: 10px;
        filter: brightness(0.9) contrast(1.2) drop-shadow(0 0 15px #9b4dff);
        transition: all 0.3s;
        animation: imageGlow 3s ease-in-out infinite;
      }

      @keyframes imageGlow {
        0%,
        100% {
          filter: brightness(0.9) contrast(1.2) drop-shadow(0 0 15px #9b4dff);
        }
        50% {
          filter: brightness(1) contrast(1.3) drop-shadow(0 0 30px #ff4dff);
        }
      }

      .preview-image:hover {
        filter: brightness(1.1) contrast(1.3) drop-shadow(0 0 40px #ffffff);
        transform: scale(1.05);
        animation: none;
      }

      .mint-controls {
        background: rgba(155, 77, 255, 0.05);
        border: 2px solid #9b4dff;
        border-radius: 20px;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .supply-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .info-box {
        background: rgba(0, 0, 0, 0.5);
        padding: 1rem;
        border-radius: 10px;
        border: 1px solid #9b4dff;
      }

      .info-label {
        color: #b792ff;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
      }

      .info-value {
        color: #fff;
        font-size: 1.5rem;
        font-weight: bold;
      }

      .price-display {
        background: linear-gradient(45deg, #9b4dff, #ff4d4d);
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
      }

      .price-label {
        font-size: 1rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .price-value {
        font-size: 2.5rem;
        font-weight: bold;
        text-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      }

      .quantity-selector {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .quantity-btn {
        background: rgba(155, 77, 255, 0.2);
        border: 2px solid #9b4dff;
        color: #fff;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s;
      }

      .quantity-btn:hover {
        background: rgba(155, 77, 255, 0.4);
        transform: scale(1.1);
      }

      .quantity-display {
        font-size: 1.5rem;
        min-width: 50px;
      }

      .mint-btn {
        background: linear-gradient(45deg, #ff4d4d, #9b4dff);
        color: white;
        border: none;
        padding: 1.5rem 3rem;
        font-size: 1.3rem;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        width: 100%;
        position: relative;
        overflow: hidden;
      }

      .mint-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .mint-btn:hover::before {
        left: 100%;
      }

      .mint-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(255, 77, 77, 0.5);
      }

      .mint-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Transaction Status */
      .transaction-status {
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #4dff4d;
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 2rem;
        display: none;
      }

      .transaction-status.error {
        border-color: #ff4d4d;
      }

      .transaction-status.pending {
        border-color: #ffd700;
      }

      .status-message {
        font-size: 1.1rem;
        margin-bottom: 1rem;
      }

      .tx-hash {
        font-family: monospace;
        font-size: 0.9rem;
        color: #b792ff;
        word-break: break-all;
      }

      .tx-link {
        color: #9b4dff;
        text-decoration: underline;
      }

      /* Navigation */
      .nav-links {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 3rem;
      }

      .nav-link {
        color: #b792ff;
        text-decoration: none;
        padding: 0.8rem 1.5rem;
        border: 1px solid #9b4dff;
        border-radius: 25px;
        transition: all 0.3s;
      }

      .nav-link:hover {
        background: rgba(155, 77, 255, 0.2);
        transform: translateY(-2px);
      }

      /* Mobile text labels */
      .nav-link-text {
        display: inline;
      }

      .nav-link-text-mobile {
        display: none;
      }

      /* Loading Spinner */
      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid #9b4dff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .mint-section {
          grid-template-columns: 1fr;
        }

        .price-value {
          font-size: 2rem;
        }

        .mint-btn {
          font-size: 1.1rem;
          padding: 1.2rem 2rem;
        }

        /* Simplify navigation buttons on mobile */
        .nav-links {
          gap: 1rem;
        }

        .nav-link {
          padding: 0.6rem 1rem;
          font-size: 0.9rem;
        }

        /* Show mobile text, hide desktop text */
        .nav-link-text {
          display: none;
        }

        .nav-link-text-mobile {
          display: inline;
        }
      }
    </style>
  </head>
  <body>
    <!-- 背景パーティクル -->
    <div class="bg-particles" id="particles"></div>

    <!-- メインコンテンツ -->
    <div class="container">
      <div class="header">
        <h1>Summon Your Nightmare</h1>
        <p class="subtitle">Mint your cursed creature from the digital abyss</p>
      </div>

      <!-- Wallet Connection Section (will be reordered on mobile) -->
      <div class="wallet-section" id="walletSection">
        <div class="wallet-status">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Wallet Not Connected</span>
        </div>
        <div class="wallet-address" id="walletAddress"></div>
        <button class="connect-btn" id="connectBtn" onclick="connectWallet()">
          Connect MetaMask
        </button>
      </div>

      <!-- Mobile Instructions Container (hidden on desktop) -->
      <div id="mobileInstructionsContainer"></div>

      <!-- Mint Section -->
      <div class="mint-section" id="mintSection" style="display: none">
        <div class="mint-preview">
          <img
            src="assets/monsters/question.svg"
            alt="Mystery Creature"
            class="preview-image"
            id="previewImage"
          />
          <p style="color: #b792ff; margin-top: 1rem; font-style: italic">
            Which nightmare will answer your call?
          </p>
        </div>

        <div class="mint-controls">
          <div
            class="contract-name-display"
            style="text-align: center; margin-bottom: 1.5rem"
          >
            <div class="contract-name-title" id="contractName">Loading...</div>
          </div>

          <div class="supply-info">
            <div class="info-box">
              <div class="info-label">Minted</div>
              <div class="info-value" id="totalSupply">0</div>
            </div>
            <div class="info-box">
              <div class="info-label">Max Supply</div>
              <div class="info-value" id="maxSupply">10,000</div>
            </div>
          </div>

          <div class="price-display">
            <div class="price-label">Price</div>
            <div class="price-value" id="priceDisplay">0.005 ETH</div>
          </div>

          <button class="mint-btn" id="mintBtn" onclick="mintNFT()" disabled>
            SUMMON NIGHTMARE
          </button>
        </div>
      </div>

      <!-- Transaction Status -->
      <div class="transaction-status" id="transactionStatus">
        <div class="status-message" id="statusMessage"></div>
        <div class="tx-hash" id="txHash"></div>
      </div>

      <!-- Navigation -->
      <div class="nav-links">
        <a href="index.html" class="nav-link">
          <span class="nav-link-text">← Back to Home</span>
          <span class="nav-link-text-mobile">Home</span>
        </a>
        <a
          href="https://opensea.io"
          class="nav-link"
          id="openseaLink"
          target="_blank"
        >
          <span class="nav-link-text">View on OpenSea</span>
          <span class="nav-link-text-mobile">OpenSea</span>
        </a>
        <a
          href="https://polygonscan.com/"
          class="nav-link"
          id="basescanLink"
          target="_blank"
        >
          <span class="nav-link-text">View on PolygonScan</span>
          <span class="nav-link-text-mobile">PolygonScan</span>
        </a>
      </div>
    </div>

    <!-- Ethers.js v6 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>

    <!-- Centralized Contract Configuration -->
    <script src="js/contracts-config.js"></script>

    <!-- Web3 Integration -->
    <script src="js/web3-integration.js"></script>

    <script>
      let nftPrice = 0.005;
      let isConnected = false;

      // パーティクル生成
      function createParticles() {
        const container = document.getElementById("particles");
        const particleCount = 30;

        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";
          particle.style.left = Math.random() * 100 + "%";
          particle.style.width = Math.random() * 4 + 2 + "px";
          particle.style.height = particle.style.width;
          particle.style.animationDelay = Math.random() * 15 + "s";
          particle.style.animationDuration = Math.random() * 10 + 15 + "s";
          container.appendChild(particle);
        }
      }

      // Update wallet UI
      window.updateWalletUI = async function (account) {
        const statusDot = document.getElementById("statusDot");
        const statusText = document.getElementById("statusText");
        const walletAddress = document.getElementById("walletAddress");
        const connectBtn = document.getElementById("connectBtn");
        const mintSection = document.getElementById("mintSection");
        const mintBtn = document.getElementById("mintBtn");

        // Mobile elements
        const mobileStatusDot = document.getElementById("mobileStatusDot");
        const mobileStatusText = document.getElementById("mobileStatusText");
        const mobileWalletAddress = document.getElementById(
          "mobileWalletAddress"
        );

        if (account) {
          isConnected = true;
          statusDot.classList.add("connected");
          statusText.textContent = "Wallet Connected";
          walletAddress.textContent =
            window.web3Integration.formatAddress(account);
          connectBtn.textContent = "Disconnect";
          mintSection.style.display = "grid";
          mintBtn.disabled = false;

          // Update mobile UI
          if (mobileStatusDot) {
            mobileStatusDot.style.background = "#4dff4d";
            mobileStatusText.textContent = "Wallet Connected";
            mobileWalletAddress.textContent =
              window.web3Integration.formatAddress(account);
          }

          // Update supply info
          updateSupplyInfo();

          // Update external links with contract address
          updateExternalLinks();
        } else {
          isConnected = false;
          statusDot.classList.remove("connected");
          statusText.textContent = "Wallet Not Connected";
          walletAddress.textContent = "";
          connectBtn.textContent = "Connect MetaMask";
          mintSection.style.display = "none";
          mintBtn.disabled = true;

          // Update mobile UI
          if (mobileStatusDot) {
            mobileStatusDot.style.background = "#ff4d4d";
            mobileStatusText.textContent = "Wallet Not Connected";
            mobileWalletAddress.textContent = "";
          }
        }
      };

      // Update OpenSea and BaseScan links with contract address
      async function updateExternalLinks() {
        try {
          // Get current chain ID
          const chainId = await window.ethereum.request({
            method: "eth_chainId",
          });
          const chainIdDecimal = parseInt(chainId, 16);

          // Get contract address for current network
          const contractAddress = window.web3Integration.getContractAddress();

          const openseaLink = document.getElementById("openseaLink");
          const basescanLink = document.getElementById("basescanLink");

          if (
            contractAddress &&
            contractAddress !== "0x0000000000000000000000000000000000000000"
          ) {
            // Update links based on network
            if (chainIdDecimal === 8453) {
              // Base Mainnet
              openseaLink.href = `https://opensea.io/assets/base/${contractAddress}`;
              basescanLink.href = `https://polygonscan.com/address/${contractAddress}`;
            } else if (chainIdDecimal === 84532) {
              // Base Sepolia Testnet
              openseaLink.href = `https://testnets.opensea.io/assets/base-sepolia/${contractAddress}`;
              basescanLink.href = `https://sepolia.polygonscan.com/address/${contractAddress}`;
            } else if (chainIdDecimal === 137) {
              // Polygon Mainnet
              openseaLink.textContent = "View on OpenSea";
              openseaLink.href = `https://opensea.io/assets/matic/${contractAddress}`;
              basescanLink.textContent = "View on PolygonScan";
              basescanLink.href = `https://polygonscan.com/address/${contractAddress}`;
            } else if (chainIdDecimal === 21201) {
              // Bon Soleil Testnet (legacy support)
              openseaLink.textContent = "View Contract";
              openseaLink.href = `https://dev2.bon-soleil.com/explorer/address/${contractAddress}`;
              basescanLink.style.display = "none"; // Hide BaseScan for custom network
            }

            console.log(
              `External links updated for contract: ${contractAddress}`
            );
          }
        } catch (error) {
          console.error("Failed to update external links:", error);
        }
      }

      // Connect/Disconnect wallet
      async function connectWallet() {
        const connectBtn = document.getElementById("connectBtn");

        if (isConnected) {
          // Disconnect
          window.web3Integration.disconnectWallet();
        } else {
          // Connect
          connectBtn.disabled = true;
          connectBtn.textContent = "Connecting...";

          try {
            const account = await window.web3Integration.connectWallet();
            window.updateWalletUI(account);
          } catch (error) {
            console.error("Connection failed:", error);

            // Check if MetaMask is not installed
            if (error.message.includes("MetaMask is not installed")) {
              showTransactionStatus(
                "error",
                "MetaMask is not installed!",
                `Please install MetaMask to mint NFTs.<br><br>
                            <a href="https://metamask.io/download/" target="_blank"
                               style="color: #A78BFA; text-decoration: none; font-weight: bold;">
                               🦊 Download MetaMask →
                            </a><br><br>
                            <small style="color: #888;">After installation, please refresh this page and try again.</small>`
              );
            } else {
              showTransactionStatus("error", error.message);
            }
          } finally {
            connectBtn.disabled = false;
            connectBtn.textContent = "Connect MetaMask";
          }
        }
      }

      // Update supply information
      async function updateSupplyInfo() {
        try {
          // Get current chain ID
          const chainId = await window.ethereum.request({
            method: "eth_chainId",
          });
          const chainIdDecimal = parseInt(chainId, 16);

          // Check if contract is deployed first
          const contractAddress = window.web3Integration.getContractAddress();

          // For Bon-Soleil testnet, always try to fetch data
          if (chainIdDecimal === 21201) {
            // Continue with fetching data even if contract address check fails
          } else if (
            !contractAddress ||
            contractAddress === "0x0000000000000000000000000000000000000000"
          ) {
            // Set default values when contract is not deployed
            document.getElementById("contractName").textContent =
              "Contract Not Deployed";
            document.getElementById("totalSupply").textContent = "0";
            document.getElementById("maxSupply").textContent = "10,000";
            document.getElementById("priceDisplay").textContent = "0.005 ETH";
            nftPrice = 0.005;
            return;
          }

          // Get contract name first
          try {
            const contractName = await window.web3Integration.getContractName();
            document.getElementById("contractName").textContent = contractName;
          } catch (error) {
            console.error("Failed to get contract name:", error);
            document.getElementById("contractName").textContent =
              "Unknown Collection";
          }

          const totalSupply = await window.web3Integration.getTotalSupply();
          const maxSupply = await window.web3Integration.getMaxSupply();

          document.getElementById("totalSupply").textContent = totalSupply;
          document.getElementById("maxSupply").textContent =
            Number(maxSupply).toLocaleString();

          // Get NFT price
          nftPrice = await window.web3Integration.getNFTPrice();
          document.getElementById(
            "priceDisplay"
          ).textContent = `${nftPrice} POL`;
        } catch (error) {
          console.error("Failed to update supply info:", error);

          // Get current chain ID
          try {
            const chainId = await window.ethereum.request({
              method: "eth_chainId",
            });
            const chainIdDecimal = parseInt(chainId, 16);

            // For Bon-Soleil testnet, show more specific error
            if (chainIdDecimal === 21201) {
              console.log(
                "Contract might not be initialized properly on testnet"
              );
              document.getElementById("contractName").textContent =
                "Loading...";
              document.getElementById("totalSupply").textContent = "Loading...";
              document.getElementById("maxSupply").textContent = "10,000";
              document.getElementById("priceDisplay").textContent = "TBD";
              nftPrice = 0.005;
            } else {
              // Set default values on error for other networks
              document.getElementById("contractName").textContent =
                "Unknown Collection";
              document.getElementById("totalSupply").textContent = "0";
              document.getElementById("maxSupply").textContent = "10,000";
              document.getElementById("priceDisplay").textContent = "0.005 ETH";
              nftPrice = 0.005;
            }
          } catch {
            // Set default values on error
            document.getElementById("contractName").textContent =
              "Unknown Collection";
            document.getElementById("totalSupply").textContent = "0";
            document.getElementById("maxSupply").textContent = "10,000";
            document.getElementById("priceDisplay").textContent = "0.005 ETH";
            nftPrice = 0.005;
          }
        }
      }

      // Mint NFT
      async function mintNFT() {
        // Check if contract is deployed
        const contractAddress = window.web3Integration.getContractAddress();

        // Get current chain ID
        const chainId = await window.ethereum.request({
          method: "eth_chainId",
        });
        const chainIdDecimal = parseInt(chainId, 16);

        // Allow minting on Bon-Soleil testnet even if contract check fails
        if (chainIdDecimal !== 21201) {
          if (
            !contractAddress ||
            contractAddress === "0x0000000000000000000000000000000000000000"
          ) {
            showComingSoonModal();
            return;
          }
        }

        const mintBtn = document.getElementById("mintBtn");
        mintBtn.disabled = true;
        mintBtn.innerHTML = '<div class="spinner"></div>';

        showTransactionStatus(
          "pending",
          "Summoning your nightmare... Please confirm the transaction in MetaMask."
        );

        try {
          const result = await window.web3Integration.mintNFT();

          if (result.success) {
            const txLink = `https://polygonscan.com/tx/${result.transactionHash}`;
            showTransactionStatus(
              "success",
              `Success! Your nightmare has been summoned! Token ID: ${
                result.tokenId || "Processing..."
              }`,
              `Transaction: <a href="${txLink}" target="_blank" class="tx-link">${result.transactionHash}</a>`
            );

            // Update supply after successful mint
            setTimeout(updateSupplyInfo, 3000);
          }
        } catch (error) {
          console.error("Minting failed:", error);
          let errorMessage = "The summoning ritual failed. ";

          if (error.message.includes("insufficient funds")) {
            errorMessage += "Insufficient ETH balance.";
          } else if (error.message.includes("user rejected")) {
            errorMessage += "Transaction was cancelled.";
          } else if (error.message.includes("Contract not initialized")) {
            // On Bon-Soleil testnet, show a different error message
            if (chainIdDecimal === 21201) {
              errorMessage =
                "Contract initialization failed. Please refresh the page and try again.";
              showTransactionStatus("error", errorMessage);
            } else {
              showComingSoonModal();
            }
            mintBtn.disabled = false;
            mintBtn.textContent = "SUMMON NIGHTMARE";
            return;
          } else {
            errorMessage += error.message;
          }

          showTransactionStatus("error", errorMessage);
        } finally {
          mintBtn.disabled = false;
          mintBtn.textContent = "SUMMON NIGHTMARE";
        }
      }

      // Show coming soon modal
      function showComingSoonModal() {
        // Create modal overlay
        const modal = document.createElement("div");
        modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.95);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                animation: fadeIn 0.3s;
            `;

        const modalContent = document.createElement("div");
        modalContent.style.cssText = `
                background: linear-gradient(180deg, #1a0a2a 0%, #0a0a0a 100%);
                border: 2px solid #9b4dff;
                border-radius: 20px;
                padding: 40px;
                text-align: center;
                max-width: 500px;
                box-shadow: 0 0 50px rgba(155, 77, 255, 0.5);
            `;

        modalContent.innerHTML = `
                <h2 style="color: #ff4d4d; font-size: 2em; margin-bottom: 20px; text-shadow: 0 0 20px rgba(255, 77, 77, 0.8);">
                    🔒 The Seal Remains Unbroken
                </h2>
                <p style="color: #e9d5ff; font-size: 1.2em; margin-bottom: 15px; line-height: 1.6;">
                    The ancient contract has not yet been inscribed into the blockchain...
                </p>
                <p style="color: #b792ff; font-size: 1.1em; margin-bottom: 30px; font-style: italic;">
                    The nightmares are still gathering their strength. Return when the moon is full.
                </p>
                <div style="background: rgba(155, 77, 255, 0.2); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: #9b4dff; font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">
                        COMING SOON
                    </p>
                    <p style="color: #b792ff; font-size: 0.9em;">
                        Pre-launch: September 1, 2025<br>
                        Main Launch: October 1, 2025
                    </p>
                </div>
                <button id="closeModalBtn" style="
                    background: linear-gradient(45deg, #9b4dff, #ff4d4d);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    font-size: 1.1em;
                    border-radius: 50px;
                    cursor: pointer;
                    font-weight: bold;
                    transition: all 0.3s;
                ">Understood</button>
            `;

        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        // Close button handler
        document.getElementById("closeModalBtn").onclick = () => {
          modal.style.animation = "fadeOut 0.3s";
          setTimeout(() => modal.remove(), 300);
        };

        // Click outside to close
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.style.animation = "fadeOut 0.3s";
            setTimeout(() => modal.remove(), 300);
          }
        });
      }

      // Show transaction status
      function showTransactionStatus(type, message, txHash = "") {
        const statusDiv = document.getElementById("transactionStatus");
        const statusMessage = document.getElementById("statusMessage");
        const txHashDiv = document.getElementById("txHash");

        statusDiv.style.display = "block";
        statusDiv.className = `transaction-status ${type}`;
        statusMessage.textContent = message;

        if (txHash) {
          txHashDiv.innerHTML = txHash;
        } else {
          txHashDiv.innerHTML = "";
        }

        if (type === "success" || type === "error") {
          setTimeout(() => {
            statusDiv.style.display = "none";
          }, 10000);
        }
      }

      // Preview image rotation
      function rotatePreviewImages() {
        const images = [
          "assets/monsters/demon.svg",
          "assets/monsters/vampire.svg",
          "assets/monsters/werewolf.svg",
          "assets/monsters/zombie.svg",
          "assets/monsters/frankenstein.svg",
          "assets/monsters/question.svg",
        ];

        let currentIndex = 0;
        const previewImg = document.getElementById("previewImage");

        setInterval(() => {
          currentIndex = (currentIndex + 1) % images.length;
          previewImg.style.opacity = "0";

          setTimeout(() => {
            previewImg.src = images[currentIndex];
            previewImg.style.opacity = "1";
          }, 300);
        }, 3000);
      }

      // Current selected language (default to browser language)
      let currentLanguage =
        localStorage.getItem("selectedLanguage") ||
        navigator.language.substring(0, 2);

      // Multi-language mobile instructions
      function showMobileInstructions() {
        // Move wallet section into mobile instructions container
        const walletSection = document.getElementById("walletSection");
        const container = document.getElementById(
          "mobileInstructionsContainer"
        );

        const translations = {
          en: {
            title: "📱 Mobile Users",
            message: "To mint NFTs on mobile, you need to use MetaMask Browser",
            clipboard:
              "✅ URL has been copied to clipboard. Please paste it in MetaMask browser.",
            steps: [
              "Tap 'Connect MetaMask' button below",
              "MetaMask app will open",
              "Go to Browser tab",
              "Paste the copied URL and connect",
            ],
          },
          ja: {
            title: "📱 モバイルユーザーの方へ",
            message:
              "モバイルでNFTをミントするには、MetaMaskブラウザが必要です",
            clipboard:
              "✅ クリップボードにURLがコピーされています。MetaMask上のブラウザにペーストしてください。",
            steps: [
              "下の「Connect MetaMask」ボタンをタップ",
              "MetaMaskアプリが開きます",
              "ブラウザタブに移動",
              "コピーされたURLを貼り付けて接続",
            ],
          },
          zh: {
            title: "📱 移动用户",
            message: "在移动设备上铸造NFT需要使用MetaMask浏览器",
            clipboard: "✅ URL已复制到剪贴板。请在MetaMask浏览器中粘贴。",
            steps: [
              "点击下方「Connect MetaMask」按钮",
              "MetaMask应用将打开",
              "转到浏览器标签",
              "粘贴复制的URL并连接",
            ],
          },
          ko: {
            title: "📱 모바일 사용자",
            message:
              "모바일에서 NFT를 민팅하려면 MetaMask 브라우저가 필요합니다",
            clipboard:
              "✅ URL이 클립보드에 복사되었습니다. MetaMask 브라우저에 붙여넣기하세요.",
            steps: [
              "아래 「Connect MetaMask」버튼 탭",
              "MetaMask 앱이 열립니다",
              "브라우저 탭으로 이동",
              "복사된 URL을 붙여넣고 연결",
            ],
          },
          es: {
            title: "📱 Usuarios Móviles",
            message:
              "Para mintear NFTs en móvil, necesitas usar el navegador MetaMask",
            clipboard:
              "✅ URL copiada al portapapeles. Por favor, pégala en el navegador MetaMask.",
            steps: [
              "Toca el botón 'Connect MetaMask' abajo",
              "Se abrirá la app MetaMask",
              "Ve a la pestaña Navegador",
              "Pega la URL copiada y conecta",
            ],
          },
          de: {
            title: "📱 Mobile Nutzer",
            message:
              "Um NFTs auf dem Handy zu minten, benötigen Sie den MetaMask Browser",
            clipboard:
              "✅ URL wurde in die Zwischenablage kopiert. Bitte fügen Sie sie im MetaMask-Browser ein.",
            steps: [
              "Tippen Sie unten auf 'Connect MetaMask'",
              "MetaMask App wird geöffnet",
              "Gehen Sie zum Browser-Tab",
              "Fügen Sie die kopierte URL ein und verbinden",
            ],
          },
        };

        // Use selected language or default to English
        const t = translations[currentLanguage] || translations.en;

        // Create info banner with language selector
        const banner = document.createElement("div");
        banner.id = "mobileBanner";
        banner.style.cssText = `
                background: linear-gradient(135deg, rgba(155, 77, 255, 0.1), rgba(255, 77, 77, 0.1));
                border: 2px solid #9b4dff;
                border-radius: 15px;
                padding: 20px;
                margin: 20px auto;
                max-width: 600px;
                text-align: center;
            `;

        // Language tabs - wrapped in container
        const langTabs = `
                <div style="background: rgba(107, 70, 193, 0.1); border-radius: 10px; padding: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: center; gap: 6px; flex-wrap: wrap;">
                        <button onclick="switchMobileLanguage('en')" style="
                            background: ${
                              currentLanguage === "en"
                                ? "linear-gradient(45deg, #6B46C1, #9333EA)"
                                : "rgba(107, 70, 193, 0.2)"
                            };
                            border: 1px solid rgba(107, 70, 193, 0.3);
                            padding: 6px 10px;
                            border-radius: 12px;
                            cursor: pointer;
                            color: ${
                              currentLanguage === "en" ? "white" : "#C084FC"
                            };
                            font-size: 11px;
                            min-width: 45px;
                        ">🇺🇸 EN</button>
                        <button onclick="switchMobileLanguage('ja')" style="
                            background: ${
                              currentLanguage === "ja"
                                ? "linear-gradient(45deg, #6B46C1, #9333EA)"
                                : "rgba(107, 70, 193, 0.2)"
                            };
                            border: 1px solid rgba(107, 70, 193, 0.3);
                            padding: 6px 10px;
                            border-radius: 12px;
                            cursor: pointer;
                            color: ${
                              currentLanguage === "ja" ? "white" : "#C084FC"
                            };
                            font-size: 11px;
                            min-width: 45px;
                        ">🇯🇵 JP</button>
                        <button onclick="switchMobileLanguage('zh')" style="
                            background: ${
                              currentLanguage === "zh"
                                ? "linear-gradient(45deg, #6B46C1, #9333EA)"
                                : "rgba(107, 70, 193, 0.2)"
                            };
                            border: 1px solid rgba(107, 70, 193, 0.3);
                            padding: 6px 10px;
                            border-radius: 12px;
                            cursor: pointer;
                            color: ${
                              currentLanguage === "zh" ? "white" : "#C084FC"
                            };
                            font-size: 11px;
                            min-width: 45px;
                        ">🇨🇳 CN</button>
                        <button onclick="switchMobileLanguage('ko')" style="
                            background: ${
                              currentLanguage === "ko"
                                ? "linear-gradient(45deg, #6B46C1, #9333EA)"
                                : "rgba(107, 70, 193, 0.2)"
                            };
                            border: 1px solid rgba(107, 70, 193, 0.3);
                            padding: 6px 10px;
                            border-radius: 12px;
                            cursor: pointer;
                            color: ${
                              currentLanguage === "ko" ? "white" : "#C084FC"
                            };
                            font-size: 11px;
                            min-width: 45px;
                        ">🇰🇷 KR</button>
                        <button onclick="switchMobileLanguage('es')" style="
                            background: ${
                              currentLanguage === "es"
                                ? "linear-gradient(45deg, #6B46C1, #9333EA)"
                                : "rgba(107, 70, 193, 0.2)"
                            };
                            border: 1px solid rgba(107, 70, 193, 0.3);
                            padding: 6px 10px;
                            border-radius: 12px;
                            cursor: pointer;
                            color: ${
                              currentLanguage === "es" ? "white" : "#C084FC"
                            };
                            font-size: 11px;
                            min-width: 45px;
                        ">🇪🇸 ES</button>
                        <button onclick="switchMobileLanguage('de')" style="
                            background: ${
                              currentLanguage === "de"
                                ? "linear-gradient(45deg, #6B46C1, #9333EA)"
                                : "rgba(107, 70, 193, 0.2)"
                            };
                            border: 1px solid rgba(107, 70, 193, 0.3);
                            padding: 6px 10px;
                            border-radius: 12px;
                            cursor: pointer;
                            color: ${
                              currentLanguage === "de" ? "white" : "#C084FC"
                            };
                            font-size: 11px;
                            min-width: 45px;
                        ">🇩🇪 DE</button>
                    </div>
                </div>
            `;

        banner.innerHTML = `
                ${langTabs}
                <h3 style="color: #ff4d4d; margin-bottom: 10px;">${t.title}</h3>
                <p style="color: #e9d5ff; margin-bottom: 10px;">${t.message}</p>
                <ol style="text-align: left; color: #b792ff; line-height: 1.8; margin: 0 0 20px 0; padding-left: 20px; padding-right: 10px;">
                    ${t.steps
                      .map(
                        (step) =>
                          `<li style="margin-bottom: 5px; word-wrap: break-word;">${step}</li>`
                      )
                      .join("")}
                </ol>
                <div class="clipboard-notif" style="background: rgba(77, 255, 77, 0.1); border: 1px solid #4dff4d; border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                    <p style="color: #4dff4d; font-weight: bold; margin: 0; font-size: 14px;">${
                      t.clipboard
                    }</p>
                </div>

                <!-- Wallet Status Section -->
                <div style="background: rgba(155, 77, 255, 0.1); border: 1px solid #9b4dff; border-radius: 15px; padding: 15px; margin-top: 20px;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
                        <span class="status-dot" id="mobileStatusDot" style="width: 10px; height: 10px; border-radius: 50%; background: #ff4d4d; animation: pulse 2s infinite;"></span>
                        <span id="mobileStatusText" style="color: #e9d5ff;">Wallet Not Connected</span>
                    </div>
                    <div id="mobileWalletAddress" style="color: #b792ff; margin-bottom: 10px;"></div>
                    <button onclick="mobileConnectWallet()" style="
                        background: linear-gradient(45deg, #9b4dff, #ff4d4d);
                        color: white;
                        border: none;
                        padding: 1rem 2rem;
                        font-size: 1.1rem;
                        border-radius: 50px;
                        cursor: pointer;
                        font-weight: bold;
                        text-transform: uppercase;
                        letter-spacing: 0.1em;
                        transition: all 0.3s;
                        display: inline-block;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(155, 77, 255, 0.5)'"
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        Connect MetaMask
                    </button>
                </div>
            `;

        // Insert into mobile instructions container
        container.appendChild(banner);

        // Hide the desktop wallet section on mobile
        walletSection.style.display = "none";
      }

      // Switch language function
      window.switchMobileLanguage = function (lang) {
        currentLanguage = lang;
        localStorage.setItem("selectedLanguage", lang);

        // Remove old banner
        const oldBanner = document.getElementById("mobileBanner");
        if (oldBanner) {
          oldBanner.remove();
        }

        // Show new banner with updated language
        showMobileInstructions();
      };

      // Mobile connect function
      function mobileConnectWallet() {
        // Copy URL to clipboard
        const currentUrl = window.location.href;
        navigator.clipboard
          .writeText(currentUrl)
          .then(() => {
            // Update clipboard notification in the banner
            const clipboardNotif = document.querySelector(
              "#mobileBanner .clipboard-notif"
            );
            if (clipboardNotif) {
              clipboardNotif.style.animation = "pulse 0.5s";
              setTimeout(() => {
                clipboardNotif.style.animation = "";
              }, 500);
            }

            // Open MetaMask app
            const deepLink =
              "metamask://dapp/" + currentUrl.replace(/^https?:\/\//, "");
            window.location.href = deepLink;
          })
          .catch((err) => {
            console.error("Failed to copy URL:", err);
            alert(
              "Please copy the URL manually and paste it in MetaMask browser"
            );
          });
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        createParticles();
        rotatePreviewImages();

        // Check if mobile and not in MetaMask browser
        const isMobile =
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent
          );
        const isMetaMaskBrowser =
          typeof window.ethereum !== "undefined" && window.ethereum.isMetaMask;

        if (isMobile && !isMetaMaskBrowser) {
          // Show mobile instructions
          showMobileInstructions();
        }

        // Check if wallet is already connected
        if (window.ethereum && window.ethereum.selectedAddress) {
          connectWallet();
        }
      });
    </script>
  </body>
</html>
