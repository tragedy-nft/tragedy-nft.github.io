<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Free SBT Campaign - The Mythical Cursed-Nightmare</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="alternate icon" href="favicon.svg" />

    <!-- Apple Touch Icon (180x180 for iOS) -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.svg" />

    <!-- PWAÂØæÂøú -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <!-- Additional Meta Tags -->
    <meta name="theme-color" content="#6B46C1" />
    <meta
      name="description"
      content="Limited Time Campaign - Mint your free SBT from The Mythical Cursed-Nightmare collection. Gas fees only."
    />

    <link rel="stylesheet" href="css/styles.css" />
    <style>
      .campaign-banner {
        background: linear-gradient(135deg, #ff6b6b 0%, #9333ea 50%, #4ecdc4 100%);
        padding: 3px;
        border-radius: 20px;
        margin: 30px 0;
        animation: gradient-animation 3s ease infinite;
        background-size: 200% 200%;
      }

      @keyframes gradient-animation {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .campaign-content {
        background: #1a0f26;
        border-radius: 17px;
        padding: 40px;
        text-align: center;
      }

      .campaign-title {
        font-size: 2.2em;
        background: linear-gradient(45deg, #ffd700, #ffa500);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: -1px;
        animation: pulse 3s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .campaign-subtitle {
        color: #e9d5ff;
        font-size: 1.2em;
        margin-bottom: 30px;
      }

      .campaign-description {
        color: #c084fc;
        font-size: 1.2em;
        line-height: 1.8;
        max-width: 600px;
        margin: 0 auto 40px;
      }

      .mint-section {
        background: rgba(107, 70, 193, 0.2);
        border: 2px solid rgba(147, 51, 234, 0.5);
        border-radius: 20px;
        padding: 40px;
        margin: 40px auto;
        max-width: 500px;
        position: relative;
        overflow: hidden;
      }

      .mint-section::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(147, 51, 234, 0.2) 0%, transparent 70%);
        animation: rotate 10s linear infinite;
      }

      @keyframes rotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .mint-button {
        background: linear-gradient(45deg, #9333ea, #6b46c1);
        color: white;
        border: none;
        padding: 20px 60px;
        font-size: 1.5em;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        z-index: 1;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: bold;
        box-shadow: 0 4px 20px rgba(147, 51, 234, 0.5);
      }

      .mint-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 30px rgba(147, 51, 234, 0.7);
      }

      .mint-button:disabled {
        background: #4b5563;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .wallet-info {
        color: #9ca3af;
        margin-top: 20px;
        font-size: 0.9em;
      }

      .contract-info {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(107, 70, 193, 0.3);
        border-radius: 15px;
        padding: 20px;
        margin: 30px auto;
        max-width: 600px;
      }

      .contract-info h3 {
        color: #c084fc;
        margin-bottom: 15px;
      }

      .contract-detail {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid rgba(107, 70, 193, 0.2);
      }

      .contract-detail:last-child {
        border-bottom: none;
      }

      .contract-label {
        color: #9ca3af;
      }

      .contract-value {
        color: #e9d5ff;
        font-family: monospace;
        font-size: 0.9em;
      }

      .contract-value a {
        color: #60a5fa !important;
        transition: all 0.3s;
      }

      .contract-value a:hover {
        color: #93bbfc !important;
        text-decoration: underline !important;
      }

      .contract-address-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .copy-button {
        background: rgba(147, 51, 234, 0.2);
        border: 1px solid rgba(147, 51, 234, 0.4);
        border-radius: 6px;
        padding: 4px 8px;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        color: #c084fc;
      }

      .copy-button:hover {
        background: rgba(147, 51, 234, 0.3);
        transform: translateY(-1px);
      }

      .copy-button.copied {
        background: rgba(34, 197, 94, 0.2);
        border-color: rgba(34, 197, 94, 0.4);
        color: #86efac;
      }

      .language-tabs {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 10px auto;
        padding: 10px 0 0;
        flex-wrap: wrap;
        width: 100%;
        text-align: center;
      }

      .lang-tab {
        background: rgba(107, 70, 193, 0.2);
        border: 1px solid rgba(107, 70, 193, 0.3);
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        color: #c084fc;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .lang-tab:hover {
        background: rgba(107, 70, 193, 0.3);
        transform: translateY(-2px);
      }

      .lang-tab.active {
        background: linear-gradient(45deg, #6b46c1, #9333ea);
        color: white;
        border-color: transparent;
      }

      .lang-flag {
        font-size: 18px;
      }

      .countdown {
        font-size: 1.4em;
        color: #ffd700;
        margin: 20px 0;
        font-weight: bold;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      }

      .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 30px;
        margin: 40px 0;
      }

      .feature-card {
        background: rgba(107, 70, 193, 0.1);
        border: 1px solid rgba(107, 70, 193, 0.3);
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s;
      }

      .feature-card:hover {
        transform: translateY(-5px);
        border-color: rgba(147, 51, 234, 0.5);
        box-shadow: 0 10px 30px rgba(147, 51, 234, 0.2);
      }

      .feature-icon {
        font-size: 3em;
        margin-bottom: 15px;
      }

      .feature-title {
        color: #c084fc;
        font-size: 1.3em;
        margin-bottom: 10px;
      }

      .feature-description {
        color: #9ca3af;
        line-height: 1.6;
      }

      .alert {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 10px;
        padding: 15px;
        margin: 20px 0;
        color: #fca5a5;
        text-align: center;
      }

      .success {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #86efac;
      }

      @media (max-width: 768px) {
        .campaign-title {
          font-size: 2em;
        }

        .campaign-content {
          padding: 20px;
        }

        .mint-section {
          padding: 30px 20px;
        }

        .mint-button {
          padding: 15px 40px;
          font-size: 1.2em;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="button-group">
        <button onclick="window.location.href='index.html'">‚Üê Back to Home</button>
        <button onclick="window.location.href='story.html'">Chronicles</button>
        <button onclick="window.location.href='manifesto.html'">Manifesto</button>
      </div>

      <div class="language-tabs">
        <div class="lang-tab active" onclick="switchLanguage('en')"><span class="lang-flag">üá∫üá∏</span> English</div>
        <div class="lang-tab" onclick="switchLanguage('ja')"><span class="lang-flag">üáØüáµ</span> Êó•Êú¨Ë™û</div>
        <div class="lang-tab" onclick="switchLanguage('zh')"><span class="lang-flag">üá®üá≥</span> ‰∏≠Êñá</div>
        <div class="lang-tab" onclick="switchLanguage('ko')"><span class="lang-flag">üá∞üá∑</span> ÌïúÍµ≠Ïñ¥</div>
        <div class="lang-tab" onclick="switchLanguage('es')"><span class="lang-flag">üá™üá∏</span> Espa√±ol</div>
        <div class="lang-tab" onclick="switchLanguage('fr')"><span class="lang-flag">üá´üá∑</span> Fran√ßais</div>
        <div class="lang-tab" onclick="switchLanguage('de')"><span class="lang-flag">üá©üá™</span> Deutsch</div>
      </div>

      <div class="campaign-banner">
        <div class="campaign-content">
          <h1 class="campaign-title" id="campaign-title">Free SBT Campaign</h1>
          <p class="campaign-subtitle" id="campaign-subtitle">Limited Time Offer - Gas Fees Only!</p>
          <div class="countdown" id="countdown">Campaign Active Now!</div>

          <p class="campaign-description" id="campaign-description">
            In Japan, August brings Obon - a time-honored tradition<br />
            when ancestral spirits return to visit their families.<br />
            <br />
            During this sacred period, the boundary between <br />
            the world of the living and the dead grows thin.<br />
            <br />
            We choose this moment to birth digital souls <br />
            that will exist eternally on the blockchain.<br />
          </p>

          <div
            style="
              background: rgba(255, 255, 255, 0.03);
              border: 1px solid rgba(255, 255, 255, 0.1);
              border-radius: 12px;
              padding: 25px 30px;
              margin: 30px auto;
              max-width: 700px;
              font-size: 0.95em;
              line-height: 1.7;
              color: rgba(255, 255, 255, 0.7);
              text-align: center;
              font-style: italic;
            "
          >
            In partnership with global digital preservation efforts,<br />
            we offer open access to this cultural documentation project<br />
            during the sacred Obon observance.
          </div>

          <div class="features-grid">
            <div class="feature-card">
              <h3 class="feature-title" id="feature-0-title">ÊúüÈñìÈôêÂÆö</h3>
              <p class="feature-description" id="feature-0-desc">„Åì„ÅÆÊôÇÊúü„Å´„Åó„ÅãÊâã„Å´ÂÖ•„Çâ„Å™„ÅÑÁâπÂà•„Å™NFT</p>
            </div>
            <div class="feature-card">
              <h3 class="feature-title" id="feature-1-title">Free Mint</h3>
              <p class="feature-description" id="feature-1-desc">No minting fees - pay only gas</p>
            </div>
            <div class="feature-card">
              <h3 class="feature-title" id="feature-2-title">Soulbound</h3>
              <p class="feature-description" id="feature-2-desc">Non-transferable, forever yours</p>
            </div>
            <div class="feature-card">
              <h3 class="feature-title" id="feature-3-title">Polygon Network</h3>
              <p class="feature-description" id="feature-3-desc">Low gas fees on Polygon</p>
            </div>
          </div>

          <div class="mint-section" id="mintSection">
            <h2 id="mint-title" style="color: #e9d5ff; margin-bottom: 20px">Mint Your Free SBT</h2>
            <p id="mint-instruction" style="color: #9ca3af; margin-bottom: 30px">
              Connect your wallet and click the button below to mint
            </p>

            <button class="mint-button" id="mintButton" onclick="mintSBT()">MINT NOW</button>

            <div class="wallet-info" id="walletInfo">Not connected to wallet</div>
          </div>

          <div class="contract-info">
            <h3 id="contract-title">Contract Information</h3>
            <div class="contract-detail">
              <span class="contract-label" id="network-label">Network:</span>
              <span class="contract-value">Polygon</span>
            </div>
            <div class="contract-detail">
              <span class="contract-label" id="contract-label">Contract:</span>
              <span class="contract-value">
                <div class="contract-address-wrapper">
                  <a
                    id="contractAddressLink"
                    href="https://opensea.io/collection/something-dark-is-awakening"
                    target="_blank"
                    style="color: #60a5fa; text-decoration: none"
                    >Loading...</a
                  >
                  <button class="copy-button" onclick="copyContractAddress()">
                    <span id="copyText">Copy</span>
                  </button>
                </div>
              </span>
            </div>
            <div class="contract-detail">
              <span class="contract-label" id="type-label">Token Type:</span>
              <span class="contract-value">SBT (Soulbound Token)</span>
            </div>
            <div class="contract-detail">
              <span class="contract-label" id="price-label">Price:</span>
              <span class="contract-value" id="price-value">FREE (Gas only)</span>
            </div>
          </div>
        </div>
      </div>

      <footer style="text-align: center; margin-top: 40px; padding-top: 20px; color: #c084fc; font-size: 14px">
        ¬© 2025 The Mythical Cursed-Nightmare
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="js/utils/console-override.js"></script>
    <script src="js/utils/format.js"></script>
    <script src="js/wallet/manager.js"></script>
    <script src="js/contracts/manager.js"></script>
    <script src="js/ui/shared-translations.js"></script>
    <script src="js/ui/campaign-translations.js"></script>
    <script src="js/ui/metamask-modal-translations.js"></script>
    <script src="js/ui/metamask-modal.js"></script>
    <script src="js/ui/components.js"></script>
    <script>
      let provider;
      let signer;
      let userAccount;
      let currentLang = localStorage.getItem('language') || 'en';
      let walletManager = null;
      let contractManager = null;

      // SBT Contract will be managed by ContractManager
      let campaignContract = null;

      // Initialize WalletManager
      async function initializeWalletManager() {
        walletManager = new WalletManager({
          defaultNetwork: 'polygon',
          onConnect: async (account, chainId) => {
            userAccount = account;
            provider = walletManager.getProvider();
            signer = walletManager.getSigner();
            updateWalletInfo();
            console.log('Wallet connected:', account, 'Chain:', chainId);

            // Initialize ContractManager with signer
            await initializeContractManager();
          },
          onDisconnect: () => {
            userAccount = null;
            provider = null;
            signer = null;
            updateWalletInfo();
            console.log('Wallet disconnected');
          },
          onAccountChange: async (account) => {
            userAccount = account;
            signer = walletManager.getSigner();
            updateWalletInfo();
            console.log('Account changed:', account);

            // Update ContractManager signer
            if (contractManager) {
              contractManager.updateSigner(signer);
            }
          },
          onNetworkChange: (chainId) => {
            console.log('Network changed:', chainId);
            window.location.reload();
          },
          onError: (error, message) => {
            showAlert(message, 'error');
          },
        });

        return await walletManager.init();
      }

      // Initialize ContractManager
      async function initializeContractManager() {
        contractManager = new ContractManager();
        await contractManager.initialize(provider, 'campaign', signer);

        // Get campaign contract
        campaignContract = contractManager.getContract('campaign');

        // Update contract address display
        const contractAddress = contractManager.getContractAddress('campaign');
        if (contractAddress) {
          const addressElement = document.getElementById('contractAddressLink');
          if (addressElement) {
            addressElement.textContent = contractAddress;
          }
          updateContractAddressDisplay();
        }
      }

      // Load settings configuration (kept for backward compatibility)
      async function loadSettings() {
        // Settings are now loaded by ContractManager
        console.log('Settings loading handled by ContractManager');
      }

      const polygonChainId = '0x89'; // 137 in hex

      // Initialize Web3 (now just a wrapper for wallet manager)
      async function initWeb3() {
        // Initialization is handled by WalletManager
        if (walletManager && walletManager.isWalletConnected()) {
          updateWalletInfo();
        }
      }

      // Update wallet info display
      function updateWalletInfo() {
        const walletInfo = document.getElementById('walletInfo');
        const mintButton = document.getElementById('mintButton');

        if (userAccount) {
          walletInfo.textContent = getTrans('wallet.connected') + ': ' + formatAddress(userAccount);
          walletInfo.style.color = '#86EFAC';
          // Update button to show "MINT NOW" when connected
          mintButton.textContent = getTrans('campaign.mint.button');
        } else {
          walletInfo.textContent = getTrans('wallet.notConnected');
          walletInfo.style.color = '#9CA3AF';
          // Update button to show "CONNECT WALLET" when not connected
          mintButton.textContent = getTrans('campaign.mint.connectButton');
        }
      }

      // Connect wallet
      async function connectWallet() {
        try {
          const account = await walletManager.connect('polygon');
          return account !== null;
        } catch (error) {
          console.error('Error connecting wallet:', error);
          showAlert(getTrans('wallet.errors.connectionFailed'), 'error');
          return false;
        }
      }

      // Switch to Polygon network
      async function switchToPolygon() {
        try {
          return await walletManager.switchNetwork('polygon');
        } catch (error) {
          console.error('Error switching to Polygon:', error);
          showAlert(getTrans('network.switchFailed'), 'error');
          return false;
        }
      }

      // Mint SBT function - Simplified version
      async function mintSBT() {
        const t = {
          alerts: {
            noWallet: getTrans('wallet.errors.noWallet'),
            switchingNetwork: getTrans('network.switching'),
            minting: getTrans('campaign.alerts.minting'),
            mintSuccess: getTrans('campaign.alerts.mintSuccess'),
            minted: getTrans('campaign.alerts.minted'),
            mintFailed: getTrans('campaign.alerts.mintFailed'),
            alreadyMinted: getTrans('campaign.alerts.alreadyMinted'),
            insufficientFunds: getTrans('wallet.errors.insufficientFunds'),
          },
        };
        const mintButton = document.getElementById('mintButton');

        // Check if Web3 is available
        if (typeof window.ethereum === 'undefined') {
          showAlert(t.alerts.noWallet, 'error');
          return;
        }

        // Connect wallet if not connected
        if (!userAccount) {
          const connected = await connectWallet();
          if (!connected) return;
          // After successful connection, button text will be updated by wallet event handler
          return; // Exit here, user needs to click again to mint
        }

        // Check if on Polygon network
        if (!walletManager.isCorrectNetwork('polygon')) {
          showAlert(t.alerts.switchingNetwork, 'info');
          const switched = await switchToPolygon();
          if (!switched) return;
        }

        // Disable button and show minting status
        mintButton.disabled = true;
        mintButton.textContent = t.alerts.minting;

        try {
          // Use campaign contract from ContractManager
          if (!campaignContract) {
            throw new Error('Campaign contract not initialized');
          }

          // Call mint function
          const tx = await campaignContract.mint();

          // Wait for transaction confirmation
          const receipt = await tx.wait();
          showAlert(t.alerts.mintSuccess, 'success');
          mintButton.textContent = t.alerts.minted;
        } catch (error) {
          console.error('Minting error:', error.message);

          // Handle different error types
          let errorMessage = t.alerts.mintFailed;

          if (error.code === 4001) {
            errorMessage = t.alerts.transactionRejected;
          } else if (error.message) {
            // Parse error message for common issues
            if (error.message.includes('Already minted')) {
              errorMessage = 'You have already minted this SBT.';
            } else if (error.message.includes('Contracts cannot mint')) {
              errorMessage = 'Contract addresses cannot mint. Please use a regular wallet.';
            } else if (error.message.includes('insufficient funds')) {
              errorMessage = 'Insufficient POL balance for gas fees.';
            } else if (error.message.includes('execution reverted')) {
              // Try to extract revert reason
              const revertMatch = error.message.match(/execution reverted: (.+?)(?:\s|$)/);
              if (revertMatch) {
                errorMessage = `Transaction failed: ${revertMatch[1]}`;
              } else {
                errorMessage = 'Transaction failed. Please try again.';
              }
            } else {
              errorMessage = `${t.alerts.mintFailed}: ${error.message}`;
            }
          }

          showAlert(errorMessage, 'error');
          mintButton.disabled = false;
          mintButton.textContent = t.mint.button;
        }
      }

      // Switch language function
      function switchLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('language', lang);

        // Update active tab
        document.querySelectorAll('.lang-tab').forEach((tab) => {
          tab.classList.remove('active');
        });
        event.target.closest('.lang-tab').classList.add('active');

        // Update content
        updateContent();
        updateWalletInfo();
      }

      // Simple translation getter
      function getTrans(key) {
        const keys = key.split('.');
        let obj = null;

        // Try to find in campaignPageTranslations first
        if (typeof campaignPageTranslations !== 'undefined') {
          obj = campaignPageTranslations;
          for (const k of keys) {
            if (obj && obj[k]) {
              obj = obj[k];
            } else {
              obj = null;
              break;
            }
          }
        }

        // If not found, try sharedTranslations
        if (!obj && typeof sharedTranslations !== 'undefined') {
          obj = sharedTranslations;
          for (const k of keys) {
            if (obj && obj[k]) {
              obj = obj[k];
            } else {
              return key; // Return key if not found
            }
          }
        }

        // Return translation for current language
        if (obj && obj[currentLang]) {
          return obj[currentLang];
        }
        return key; // Return key if translation not found
      }

      // Update all content based on selected language
      function updateContent() {
        console.log('updateContent called, currentLang:', currentLang);

        // Update titles and descriptions
        const title = getTrans('campaign.title');
        console.log('campaign.title translation:', title);
        document.getElementById('campaign-title').textContent = title;
        document.getElementById('campaign-subtitle').textContent = getTrans('campaign.subtitle');
        document.getElementById('campaign-description').innerHTML = getTrans('campaign.description');
        document.getElementById('countdown').textContent = getTrans('campaign.countdown');

        // Update features
        document.getElementById('feature-0-title').textContent = getTrans('campaign.features.limited.title');
        document.getElementById('feature-0-desc').textContent = getTrans('campaign.features.limited.desc');
        document.getElementById('feature-1-title').textContent = getTrans('campaign.features.free.title');
        document.getElementById('feature-1-desc').textContent = getTrans('campaign.features.free.desc');
        document.getElementById('feature-2-title').textContent = getTrans('campaign.features.soulbound.title');
        document.getElementById('feature-2-desc').textContent = getTrans('campaign.features.soulbound.desc');
        document.getElementById('feature-3-title').textContent = getTrans('network.polygon.name');
        document.getElementById('feature-3-desc').textContent = getTrans('campaign.features.polygon.desc');

        // Update mint section
        document.getElementById('mint-title').textContent = getTrans('campaign.mint.title');
        document.getElementById('mint-instruction').textContent = getTrans('campaign.mint.instruction');
        // Button text will be set by updateWalletInfo() based on connection status

        // Update contract info
        document.getElementById('contract-title').textContent = getTrans('campaign.contract.title');
        document.getElementById('network-label').textContent = getTrans('campaign.contract.network');
        document.getElementById('contract-label').textContent = getTrans('campaign.contract.address');
        document.getElementById('type-label').textContent = getTrans('campaign.contract.type');
        document.getElementById('price-label').textContent = getTrans('campaign.contract.price');
        document.getElementById('price-value').textContent = getTrans('campaign.contract.priceValue');

        // Update button
        document.querySelector('button[onclick*="index.html"]').textContent = getTrans('ui.buttons.back');
      }

      // Copy contract address function
      function copyContractAddress() {
        const address = contractManager ? contractManager.getContractAddress('campaign') : '';
        navigator.clipboard
          .writeText(address)
          .then(() => {
            const copyButton = document.querySelector('.copy-button');
            const copyIcon = document.getElementById('copyIcon');
            const copyText = document.getElementById('copyText');

            // Add copied class
            copyButton.classList.add('copied');
            copyIcon.textContent = '';
            copyText.textContent = 'Copied!';

            // Reset after 2 seconds
            setTimeout(() => {
              copyButton.classList.remove('copied');
              copyIcon.textContent = '';
              copyText.textContent = 'Copy';
            }, 2000);
          })
          .catch((err) => {
            console.error('Failed to copy:', err);
            alert('Failed to copy address');
          });
      }

      // Update contract address display based on screen size
      function updateContractAddressDisplay() {
        const addressLink = document.getElementById('contractAddressLink');
        if (addressLink && contractManager) {
          const contractAddress = contractManager.getContractAddress('campaign');
          if (contractAddress) {
            // Only format on mobile
            if (window.innerWidth <= 768) {
              addressLink.textContent = formatAddress(contractAddress);
            } else {
              addressLink.textContent = contractAddress;
            }
          }
        }
      }

      // Check if mobile and redirect to MetaMask browser if needed
      function checkMobileMetaMask() {
        const ua = navigator.userAgent.toLowerCase();
        const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua);
        const isMetaMaskBrowser = window.ethereum && window.ethereum.isMetaMask;

        if (isMobile && !isMetaMaskBrowser) {
          // Redirect to MetaMask app with deep link
          const currentUrl = window.location.href;
          const metamaskDeepLink = `https://metamask.app.link/dapp/${currentUrl.replace(/^https?:\/\//, '')}`;

          // Show alert before redirecting
          const shouldRedirect = confirm(
            getTrans('metamask.mobileRedirect') ||
              'This dApp works best in MetaMask browser. Would you like to open it in MetaMask?'
          );

          if (shouldRedirect) {
            window.location.href = metamaskDeepLink;
          }
        }
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', async () => {
        // Translations are now handled directly in updateContent

        // Check browser and show MetaMask warning
        checkBrowserAndShowMetaMaskWarning();

        // Check mobile MetaMask
        checkMobileMetaMask();
        // Initialize UI Components
        initializeUIStyles();

        await initializeWalletManager();

        // Initialize ContractManager without signer if wallet already connected
        if (walletManager && walletManager.isWalletConnected()) {
          provider = walletManager.getProvider();
          signer = walletManager.getSigner();
          await initializeContractManager();
        }

        initWeb3();

        // Set active language tab
        document.querySelectorAll('.lang-tab').forEach((tab) => {
          if (tab.onclick.toString().includes(currentLang)) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });

        // Update content to saved language
        updateContent();

        // Update contract address display
        updateContractAddressDisplay();

        // Update on resize
        window.addEventListener('resize', updateContractAddressDisplay);
      });
    </script>
  </body>
</html>
