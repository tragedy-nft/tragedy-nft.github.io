<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Free SBT Campaign - The Mythical Cursed-Nightmare</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="alternate icon" href="favicon.svg" />

    <!-- Apple Touch Icon (180x180 for iOS) -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.svg" />

    <!-- PWAÂØæÂøú -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <!-- Additional Meta Tags -->
    <meta name="theme-color" content="#6B46C1" />
    <meta
      name="description"
      content="Limited Time Campaign - Mint your free SBT from The Mythical Cursed-Nightmare collection. Gas fees only."
    />

    <link rel="stylesheet" href="css/styles.css" />
    <style>
      .campaign-banner {
        background: linear-gradient(
          135deg,
          #ff6b6b 0%,
          #9333ea 50%,
          #4ecdc4 100%
        );
        padding: 3px;
        border-radius: 20px;
        margin: 30px 0;
        animation: gradient-animation 3s ease infinite;
        background-size: 200% 200%;
      }

      @keyframes gradient-animation {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .campaign-content {
        background: #1a0f26;
        border-radius: 17px;
        padding: 40px;
        text-align: center;
      }

      .campaign-title {
        font-size: 2.2em;
        background: linear-gradient(45deg, #ffd700, #ffa500);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: -1px;
        animation: pulse 3s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .campaign-subtitle {
        color: #e9d5ff;
        font-size: 1.2em;
        margin-bottom: 30px;
      }

      .campaign-description {
        color: #c084fc;
        font-size: 1.2em;
        line-height: 1.8;
        max-width: 600px;
        margin: 0 auto 40px;
      }

      .mint-section {
        background: rgba(107, 70, 193, 0.2);
        border: 2px solid rgba(147, 51, 234, 0.5);
        border-radius: 20px;
        padding: 40px;
        margin: 40px auto;
        max-width: 500px;
        position: relative;
        overflow: hidden;
      }

      .mint-section::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(147, 51, 234, 0.2) 0%,
          transparent 70%
        );
        animation: rotate 10s linear infinite;
      }

      @keyframes rotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .mint-button {
        background: linear-gradient(45deg, #9333ea, #6b46c1);
        color: white;
        border: none;
        padding: 20px 60px;
        font-size: 1.5em;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        z-index: 1;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: bold;
        box-shadow: 0 4px 20px rgba(147, 51, 234, 0.5);
      }

      .mint-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 30px rgba(147, 51, 234, 0.7);
      }

      .mint-button:disabled {
        background: #4b5563;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .wallet-info {
        color: #9ca3af;
        margin-top: 20px;
        font-size: 0.9em;
      }

      .contract-info {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(107, 70, 193, 0.3);
        border-radius: 15px;
        padding: 20px;
        margin: 30px auto;
        max-width: 600px;
      }

      .contract-info h3 {
        color: #c084fc;
        margin-bottom: 15px;
      }

      .contract-detail {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid rgba(107, 70, 193, 0.2);
      }

      .contract-detail:last-child {
        border-bottom: none;
      }

      .contract-label {
        color: #9ca3af;
      }

      .contract-value {
        color: #e9d5ff;
        font-family: monospace;
        font-size: 0.9em;
      }

      .contract-value a {
        color: #60a5fa !important;
        transition: all 0.3s;
      }

      .contract-value a:hover {
        color: #93bbfc !important;
        text-decoration: underline !important;
      }

      .language-tabs {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .lang-tab {
        background: rgba(107, 70, 193, 0.2);
        border: 1px solid rgba(107, 70, 193, 0.3);
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        color: #c084fc;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .lang-tab:hover {
        background: rgba(107, 70, 193, 0.3);
        transform: translateY(-2px);
      }

      .lang-tab.active {
        background: linear-gradient(45deg, #6b46c1, #9333ea);
        color: white;
        border-color: transparent;
      }

      .lang-flag {
        font-size: 18px;
      }

      .countdown {
        font-size: 1.4em;
        color: #ffd700;
        margin: 20px 0;
        font-weight: bold;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      }

      .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 30px;
        margin: 40px 0;
      }

      .feature-card {
        background: rgba(107, 70, 193, 0.1);
        border: 1px solid rgba(107, 70, 193, 0.3);
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s;
      }

      .feature-card:hover {
        transform: translateY(-5px);
        border-color: rgba(147, 51, 234, 0.5);
        box-shadow: 0 10px 30px rgba(147, 51, 234, 0.2);
      }

      .feature-icon {
        font-size: 3em;
        margin-bottom: 15px;
      }

      .feature-title {
        color: #c084fc;
        font-size: 1.3em;
        margin-bottom: 10px;
      }

      .feature-description {
        color: #9ca3af;
        line-height: 1.6;
      }

      .alert {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 10px;
        padding: 15px;
        margin: 20px 0;
        color: #fca5a5;
        text-align: center;
      }

      .success {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #86efac;
      }

      @media (max-width: 768px) {
        .campaign-title {
          font-size: 2em;
        }

        .campaign-content {
          padding: 20px;
        }

        .mint-section {
          padding: 30px 20px;
        }

        .mint-button {
          padding: 15px 40px;
          font-size: 1.2em;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="button-group">
        <button onclick="window.location.href='index.html'">
          ‚Üê Back to Home
        </button>
        <button onclick="window.location.href='story.html'">Chronicles</button>
        <button onclick="window.location.href='manifest.html'">
          Manifesto
        </button>
      </div>

      <div class="language-tabs">
        <div class="lang-tab active" onclick="switchLanguage('en')">
          <span class="lang-flag">üá∫üá∏</span> English
        </div>
        <div class="lang-tab" onclick="switchLanguage('ja')">
          <span class="lang-flag">üáØüáµ</span> Êó•Êú¨Ë™û
        </div>
        <div class="lang-tab" onclick="switchLanguage('zh')">
          <span class="lang-flag">üá®üá≥</span> ‰∏≠Êñá
        </div>
        <div class="lang-tab" onclick="switchLanguage('ko')">
          <span class="lang-flag">üá∞üá∑</span> ÌïúÍµ≠Ïñ¥
        </div>
        <div class="lang-tab" onclick="switchLanguage('es')">
          <span class="lang-flag">üá™üá∏</span> Espa√±ol
        </div>
        <div class="lang-tab" onclick="switchLanguage('fr')">
          <span class="lang-flag">üá´üá∑</span> Fran√ßais
        </div>
      </div>

      <div class="campaign-banner">
        <div class="campaign-content">
          <h1 class="campaign-title" id="campaign-title">Free SBT Campaign</h1>
          <p class="campaign-subtitle" id="campaign-subtitle">
            Limited Time Offer - Gas Fees Only!
          </p>
          <div class="countdown" id="countdown">Campaign Active Now!</div>

          <p class="campaign-description" id="campaign-description">
            In Japan, August brings Obon - a time-honored tradition<br />
            when ancestral spirits return to visit their families.<br />
            <br />
            During this sacred period, the boundary between <br />
            the world of the living and the dead grows thin.<br />
            <br />
            We choose this moment to birth digital souls <br />
            that will exist eternally on the blockchain.<br />
          </p>

          <div class="features-grid">
            <div class="feature-card">
              <h3 class="feature-title" id="feature-0-title">ÊúüÈñìÈôêÂÆö</h3>
              <p class="feature-description" id="feature-0-desc">
                „Åì„ÅÆÊôÇÊúü„Å´„Åó„ÅãÊâã„Å´ÂÖ•„Çâ„Å™„ÅÑÁâπÂà•„Å™NFT
              </p>
            </div>
            <div class="feature-card">
              <h3 class="feature-title" id="feature-1-title">Free Mint</h3>
              <p class="feature-description" id="feature-1-desc">
                No minting fees - pay only gas
              </p>
            </div>
            <div class="feature-card">
              <h3 class="feature-title" id="feature-2-title">Soulbound</h3>
              <p class="feature-description" id="feature-2-desc">
                Non-transferable, forever yours
              </p>
            </div>
            <div class="feature-card">
              <h3 class="feature-title" id="feature-3-title">
                Polygon Network
              </h3>
              <p class="feature-description" id="feature-3-desc">
                Low gas fees on Polygon
              </p>
            </div>
          </div>

          <div class="mint-section">
            <h2 id="mint-title" style="color: #e9d5ff; margin-bottom: 20px">
              Mint Your Free SBT
            </h2>
            <p
              id="mint-instruction"
              style="color: #9ca3af; margin-bottom: 30px"
            >
              Connect your wallet and click the button below to mint
            </p>

            <button class="mint-button" id="mintButton" onclick="mintSBT()">
              MINT NOW
            </button>

            <div class="wallet-info" id="walletInfo">
              Not connected to wallet
            </div>

            <div id="alertMessage"></div>
          </div>

          <div class="contract-info">
            <h3 id="contract-title">Contract Information</h3>
            <div class="contract-detail">
              <span class="contract-label" id="network-label">Network:</span>
              <span class="contract-value">Polygon</span>
            </div>
            <div class="contract-detail">
              <span class="contract-label" id="contract-label">Contract:</span>
              <span class="contract-value"
                ><a
                  href="https://opensea.io/collection/something-dark-is-awakening"
                  target="_blank"
                  style="color: #60a5fa; text-decoration: none"
                  >0x800472c573b2f195d3f282e9befdb7bb7db30b8d</a
                ></span
              >
            </div>
            <div class="contract-detail">
              <span class="contract-label" id="type-label">Token Type:</span>
              <span class="contract-value">SBT (Soulbound Token)</span>
            </div>
            <div class="contract-detail">
              <span class="contract-label" id="price-label">Price:</span>
              <span class="contract-value" id="price-value"
                >FREE (Gas only)</span
              >
            </div>
          </div>
        </div>
      </div>

      <footer
        style="
          text-align: center;
          margin-top: 40px;
          padding-top: 20px;
          color: #c084fc;
          font-size: 14px;
        "
      >
        ¬© 2025 The Mythical Cursed-Nightmare
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="js/campaign-translations.js"></script>
    <script>
      let provider;
      let signer;
      let userAccount;
      let currentLang = localStorage.getItem("selectedLanguage") || "en";

      // SBT Contract configuration
      const contractAddress = "0x800472c573b2f195d3f282e9befdb7bb7db30b8d";
      const contractABI = ["function mint() public"];

      const polygonChainId = "0x89"; // 137 in hex

      // Initialize ethers and check wallet connection
      async function initWeb3() {
        if (typeof window.ethereum !== "undefined") {
          provider = new ethers.providers.Web3Provider(window.ethereum);

          // Check if already connected
          const accounts = await provider.listAccounts();
          if (accounts.length > 0) {
            userAccount = accounts[0];
            signer = provider.getSigner();
            updateWalletInfo();
          }

          // Listen for account changes
          window.ethereum.on("accountsChanged", (accounts) => {
            if (accounts.length > 0) {
              userAccount = accounts[0];
              signer = provider.getSigner();
              updateWalletInfo();
            } else {
              userAccount = null;
              signer = null;
              updateWalletInfo();
            }
          });

          // Listen for chain changes
          window.ethereum.on("chainChanged", () => {
            window.location.reload();
          });
        }
      }

      // Update wallet info display
      function updateWalletInfo() {
        const walletInfo = document.getElementById("walletInfo");
        const t = campaignTranslations[currentLang];

        if (userAccount) {
          walletInfo.textContent =
            t.wallet.connected +
            ": " +
            userAccount.substring(0, 6) +
            "..." +
            userAccount.substring(38);
          walletInfo.style.color = "#86EFAC";
        } else {
          walletInfo.textContent = t.wallet.notConnected;
          walletInfo.style.color = "#9CA3AF";
        }
      }

      // Connect wallet
      async function connectWallet() {
        try {
          const accounts = await window.ethereum.request({
            method: "eth_requestAccounts",
          });
          userAccount = accounts[0];
          signer = provider.getSigner();
          updateWalletInfo();
          return true;
        } catch (error) {
          console.error("Error connecting wallet:", error);
          showAlert(
            campaignTranslations[currentLang].alerts.walletConnectionFailed,
            "error"
          );
          return false;
        }
      }

      // Switch to Polygon network
      async function switchToPolygon() {
        try {
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: polygonChainId }],
          });
          return true;
        } catch (switchError) {
          // This error code indicates that the chain has not been added to MetaMask
          if (switchError.code === 4902) {
            try {
              await window.ethereum.request({
                method: "wallet_addEthereumChain",
                params: [
                  {
                    chainId: polygonChainId,
                    chainName: "Polygon",
                    nativeCurrency: {
                      name: "MATIC",
                      symbol: "MATIC",
                      decimals: 18,
                    },
                    rpcUrls: ["https://polygon-rpc.com/"],
                    blockExplorerUrls: ["https://polygonscan.com/"],
                  },
                ],
              });
              return true;
            } catch (addError) {
              console.error("Error adding Polygon network:", addError);
              showAlert(
                campaignTranslations[currentLang].alerts.networkAddFailed,
                "error"
              );
              return false;
            }
          }
          console.error("Error switching to Polygon:", switchError);
          showAlert(
            campaignTranslations[currentLang].alerts.networkSwitchFailed,
            "error"
          );
          return false;
        }
      }

      // Mint SBT function - Simplified version
      async function mintSBT() {
        const t = campaignTranslations[currentLang];
        const mintButton = document.getElementById("mintButton");

        // Check if Web3 is available
        if (typeof window.ethereum === "undefined") {
          showAlert(t.alerts.noWallet, "error");
          return;
        }

        // Connect wallet if not connected
        if (!userAccount) {
          const connected = await connectWallet();
          if (!connected) return;
        }

        // Check if on Polygon network
        const network = await provider.getNetwork();
        if (network.chainId !== 137) {
          showAlert(t.alerts.switchingNetwork, "info");
          const switched = await switchToPolygon();
          if (!switched) return;
        }

        // Disable button and show minting status
        mintButton.disabled = true;
        mintButton.textContent = t.alerts.minting;

        try {
          // Create contract instance
          const contract = new ethers.Contract(
            contractAddress,
            contractABI,
            signer
          );

          // Debug info
          console.log("=== Mint Debug Info ===");
          console.log("Contract Address:", contractAddress);
          console.log("User Account:", userAccount);
          console.log("Network:", await provider.getNetwork());

          // Call mint function
          const tx = await contract.mint();
          console.log("Transaction sent:", tx.hash);

          // Wait for transaction confirmation
          const receipt = await tx.wait();

          console.log("Transaction receipt:", receipt);
          showAlert(t.alerts.mintSuccess, "success");
          mintButton.textContent = t.alerts.minted;
        } catch (error) {
          console.error("=== Minting Error Details ===");
          console.error("Full error object:", error);
          console.error("Error message:", error.message);
          console.error("Error code:", error.code);
          console.error("Error data:", error.data);

          // Handle different error types
          let errorMessage = t.alerts.mintFailed;

          if (error.code === 4001) {
            errorMessage = t.alerts.transactionRejected;
          } else if (error.message) {
            // Parse error message for common issues
            if (error.message.includes("Already minted")) {
              errorMessage = "You have already minted this SBT.";
            } else if (error.message.includes("Contracts cannot mint")) {
              errorMessage =
                "Contract addresses cannot mint. Please use a regular wallet.";
            } else if (error.message.includes("insufficient funds")) {
              errorMessage = "Insufficient MATIC balance for gas fees.";
            } else if (error.message.includes("execution reverted")) {
              // Try to extract revert reason
              const revertMatch = error.message.match(
                /execution reverted: (.+?)(?:\s|$)/
              );
              if (revertMatch) {
                errorMessage = `Transaction failed: ${revertMatch[1]}`;
              } else {
                errorMessage = "Transaction failed. Please try again.";
              }
            } else {
              errorMessage = `${t.alerts.mintFailed}: ${error.message}`;
            }
          }

          showAlert(errorMessage, "error");
          mintButton.disabled = false;
          mintButton.textContent = t.mint.button;
        }
      }

      // Show alert message
      function showAlert(message, type) {
        const alertDiv = document.getElementById("alertMessage");
        alertDiv.textContent = message;
        alertDiv.className = type === "success" ? "alert success" : "alert";

        // Auto hide after 5 seconds
        setTimeout(() => {
          alertDiv.textContent = "";
          alertDiv.className = "";
        }, 5000);
      }

      // Switch language function
      function switchLanguage(lang) {
        currentLang = lang;
        localStorage.setItem("selectedLanguage", lang);

        // Update active tab
        document.querySelectorAll(".lang-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.closest(".lang-tab").classList.add("active");

        // Update content
        updateContent();
        updateWalletInfo();
      }

      // Update all content based on selected language
      function updateContent() {
        const t = campaignTranslations[currentLang];

        // Update titles and descriptions
        document.getElementById("campaign-title").textContent = t.title;
        document.getElementById("campaign-subtitle").textContent = t.subtitle;
        document.getElementById("campaign-description").innerHTML =
          t.description;
        document.getElementById("countdown").textContent = t.countdown;

        // Update features
        // Update feature-0 if it exists in translations
        if (t.features.limited) {
          document.getElementById("feature-0-title").textContent =
            t.features.limited.title;
          document.getElementById("feature-0-desc").textContent =
            t.features.limited.desc;
        }

        document.getElementById("feature-1-title").textContent =
          t.features.free.title;
        document.getElementById("feature-1-desc").textContent =
          t.features.free.desc;
        document.getElementById("feature-2-title").textContent =
          t.features.soulbound.title;
        document.getElementById("feature-2-desc").textContent =
          t.features.soulbound.desc;
        document.getElementById("feature-3-title").textContent =
          t.features.polygon.title;
        document.getElementById("feature-3-desc").textContent =
          t.features.polygon.desc;

        // Update mint section
        document.getElementById("mint-title").textContent = t.mint.title;
        document.getElementById("mint-instruction").textContent =
          t.mint.instruction;
        document.getElementById("mintButton").textContent = t.mint.button;

        // Update contract info
        document.getElementById("contract-title").textContent =
          t.contract.title;
        document.getElementById("network-label").textContent =
          t.contract.network;
        document.getElementById("contract-label").textContent =
          t.contract.address;
        document.getElementById("type-label").textContent = t.contract.type;
        document.getElementById("price-label").textContent = t.contract.price;
        document.getElementById("price-value").textContent =
          t.contract.priceValue;

        // Update button
        document.querySelector('button[onclick*="index.html"]').textContent =
          t.backButton;
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        initWeb3();

        // Set active language tab
        document.querySelectorAll(".lang-tab").forEach((tab) => {
          if (tab.onclick.toString().includes(currentLang)) {
            tab.classList.add("active");
          } else {
            tab.classList.remove("active");
          }
        });

        // Update content to saved language
        updateContent();
      });
    </script>
  </body>
</html>
